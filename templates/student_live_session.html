<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Session ‚Ä¢ Digi Kul</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/api/student/dashboard">
                <i class="bi bi-mortarboard me-2"></i>
                Digi Kul - Live Session
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle me-1"></i>
                    Student
                </span>
                <button class="btn btn-outline-light" onclick="leaveSession()">
                    <i class="bi bi-box-arrow-right me-1"></i>Leave Session
                </button>
            </div>
        </div>
    </nav>

<style>
    .main-container {
        display: flex;
        height: calc(100vh - 120px);
        gap: 1rem;
    }
    
    .video-container {
        flex: 2;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    
    .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        padding: 1rem;
        height: 100%;
        overflow-y: auto;
    }
    
    .video-wrapper {
        position: relative;
        background: #333;
        border-radius: 8px;
        overflow: hidden;
        min-height: 200px;
    }
    
    .video-wrapper.teacher {
        border: 3px solid #28a745;
    }
    
    .video-wrapper.student {
        border: 2px solid #6c757d;
    }
    
    .video-wrapper video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .video-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
    }
    
    .video-controls {
        position: absolute;
        bottom: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
    }
    
    .control-btn-small {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 50%;
        background: rgba(0,0,0,0.7);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .sidebar {
        width: 300px;
        background: #f8f9fa;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .sidebar-tabs {
        display: flex;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
    }
    
    .sidebar-tab {
        flex: 1;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        border: none;
        background: transparent;
        font-size: 12px;
        transition: background-color 0.3s;
    }
    
    .sidebar-tab.active {
        background: #007bff;
        color: white;
    }
    
    .tab-panel {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: none;
    }
    
    .tab-panel.active {
        display: block;
    }
    
    .chat-messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        background: white;
        margin-bottom: 10px;
    }
    
    .chat-input {
        display: flex;
        gap: 5px;
    }
    
    .chat-input input {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 8px 15px;
        outline: none;
    }
    
    .chat-input button {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: none;
        background: #007bff;
        color: white;
        cursor: pointer;
    }
    
    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .message.own {
        background: #007bff;
        color: white;
        margin-left: auto;
    }
    
    .message.other {
        background: #e9ecef;
        color: #333;
    }
    
    .message-header {
        font-size: 11px;
        opacity: 0.7;
        margin-bottom: 2px;
    }
    
    .participant {
        display: flex;
        align-items: center;
        padding: 8px;
        margin: 5px 0;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .participant-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        margin-right: 10px;
    }
    
    .participant-info {
        flex: 1;
    }
    
    .participant-name {
        font-weight: bold;
        font-size: 14px;
    }
    
    .participant-type {
        font-size: 12px;
        color: #6c757d;
        text-transform: capitalize;
    }
    
    .materials-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .material-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .material-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        color: #6c757d;
    }
    
    .material-info {
        flex: 1;
    }
    
    .material-name {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 2px;
    }
    
    .material-size {
        font-size: 12px;
        color: #6c757d;
    }
    
    .material-actions {
        display: flex;
        gap: 5px;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
    }
    
    .session-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0,0,0,0.8);
        padding: 10px 20px;
        border-radius: 25px;
        z-index: 1000;
    }
    
    .control-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.3s;
    }
    
    .control-btn.active {
        background: #dc3545;
    }
    
    .control-btn:hover {
        transform: scale(1.1);
    }
    
    .whiteboard-canvas {
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: crosshair;
        background: white;
        width: 100%;
        height: 400px;
    }
    
    .whiteboard-controls {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    
    .whiteboard-controls button {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 12px;
    }
    
    .whiteboard-controls button.active {
        background: #007bff;
        color: white;
    }
    
    .whiteboard-controls input[type="color"] {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .whiteboard-controls input[type="range"] {
        width: 80px;
    }
    
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
    }
</style>

<div class="container-fluid p-3">
    <div class="main-container">
        <!-- Video Container -->
        <div class="video-container">
            <div class="video-grid" id="videoGrid">
                <!-- Videos will be added here dynamically -->
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchTab('chat')">
                    <i class="bi bi-chat-dots"></i><br>Chat
                </button>
                <button class="sidebar-tab" onclick="switchTab('participants')">
                    <i class="bi bi-people"></i><br>People
                </button>
                <button class="sidebar-tab" onclick="switchTab('materials')">
                    <i class="bi bi-file-earmark-text"></i><br>Materials
                </button>
                <button class="sidebar-tab" onclick="switchTab('whiteboard')">
                    <i class="bi bi-pencil-square"></i><br>Whiteboard
                </button>
            </div>
            
            <!-- Chat Panel -->
            <div id="chat-panel" class="tab-panel active">
                <div class="chat-messages" id="chat-messages">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-chat-dots fs-1"></i>
                        <p class="mt-2">No messages yet</p>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="handleChatKeypress(event)">
                    <button onclick="sendChatMessage()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
            
            <!-- Participants Panel -->
            <div id="participants-panel" class="tab-panel">
                <div id="participants-list">
                    <!-- Participants will be added here -->
                </div>
            </div>
            
            <!-- Materials Panel -->
            <div id="materials-panel" class="tab-panel">
                <div class="materials-list" id="materials-list">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-file-earmark-text fs-1"></i>
                        <p class="mt-2">No materials available</p>
                    </div>
                </div>
            </div>
            
            <!-- Whiteboard Panel -->
            <div id="whiteboard-panel" class="tab-panel">
                <div class="whiteboard-controls">
                    <button onclick="setWhiteboardTool('pen')" id="pen-tool" class="active">‚úèÔ∏è Pen</button>
                    <button onclick="setWhiteboardTool('eraser')" id="eraser-tool">üßπ Eraser</button>
                    <input type="color" id="color-picker" onchange="setWhiteboardColor(this.value)" value="#000000">
                    <input type="range" id="brush-size" min="1" max="10" value="3" onchange="setBrushSize(this.value)">
                    <button onclick="clearWhiteboard()" style="background: #dc3545; color: white;">Clear</button>
                </div>
                <canvas id="whiteboard-canvas" class="whiteboard-canvas" width="300" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Session Controls -->
<div class="session-controls">
    <div id="participants-count">üë• 0 participants</div>
    <button class="control-btn" id="mic-btn" title="Toggle Microphone" onclick="toggleMicrophone()">üé§</button>
    <button class="control-btn" id="cam-btn" title="Toggle Camera" onclick="toggleCamera()">üìπ</button>
    <button class="control-btn" id="leave-btn" title="Leave Session" style="background: #dc3545;">‚ùå</button>
</div>

<div id="alert" class="alert"></div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    // Global variables
    let socket = null;
    let currentUser = null;
    let sessionId = null;
    let isMuted = false;
    let isVideoOff = false;
    let localStream = null;
    let peerConnections = new Map();
    let remoteStreams = new Map();
    let currentLectureId = null;
    
    // Whiteboard variables
    let whiteboardCanvas = null;
    let whiteboardCtx = null;
    let isDrawing = false;
    let currentTool = 'pen';
    let currentColor = '#000000';
    let brushSize = 3;
    let lastX = 0;
    let lastY = 0;
    
    // WebRTC configuration
    const rtcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeSession();
        setupEventListeners();
    });
    
    async function initializeSession() {
        try {
            // Get user info from Flask session
            const userType = '{{ session.user_type }}';
            const userName = '{{ session.user_name }}';
            const userId = '{{ session.user_id }}';
            
            currentUser = {
                id: userId,
                type: userType,
                name: userName
            };
            
            // Connect to socket
            socket = io();
            
            // Setup socket event listeners
            setupSocketListeners();
            
            // Get user media (video and audio for students)
            await getUserMedia();
            
            // Get session info
            sessionId = '{{ session_id }}';
            currentLectureId = '{{ lecture_id }}';
            
            console.log('Current Lecture ID:', currentLectureId);
            
            // Initialize whiteboard
            initializeWhiteboard();
            
        } catch (error) {
            console.error('Failed to initialize session:', error);
            showError('Failed to join session: ' + error.message);
        }
    }
    
    function setupSocketListeners() {
        socket.on('session_info', (data) => {
            updateParticipantsList(data.participants);
        });
        
        socket.on('user_joined', (data) => {
            console.log('User joined:', data);
            addParticipant(data);
            updateParticipantsCount();
        });
        
        socket.on('user_left', (data) => {
            console.log('User left:', data);
            removeParticipant(data.user_id);
            updateParticipantsCount();
        });
        
        socket.on('chat_message', (data) => {
            console.log('Received chat message:', data);
            addChatMessage(data.user_name, data.message, data.timestamp, data.user_id === currentUser.id);
        });
        
        socket.on('webrtc_offer', handleOffer);
        socket.on('webrtc_answer', handleAnswer);
        socket.on('webrtc_ice_candidate', handleICECandidate);
        
        socket.on('whiteboard_draw', (data) => {
            if (data.user_id === currentUser.id) return;
            drawRemoteWhiteboard(data.drawing_data);
        });
        
        socket.on('whiteboard_clear', (data) => {
            if (data.user_id === currentUser.id) return;
            if (whiteboardCtx) {
                whiteboardCtx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
            }
        });
        
        socket.on('screen_share_started', (data) => {
            console.log('Screen sharing started by:', data.user_name);
            showAlert('Screen sharing started', 'info');
        });
        
        socket.on('screen_share_stopped', (data) => {
            console.log('Screen sharing stopped by:', data.user_name);
            showAlert('Screen sharing stopped', 'info');
        });
    }
    
    function setupEventListeners() {
        // Microphone toggle
        document.getElementById('mic-btn').addEventListener('click', toggleMicrophone);
        
        // Camera toggle
        document.getElementById('cam-btn').addEventListener('click', toggleCamera);
        
        // Leave session
        document.getElementById('leave-btn').addEventListener('click', leaveSession);
        
        // Chat input
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }
    
    async function getUserMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 480, max: 720 },
                    frameRate: { ideal: 15, max: 30 }
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            // Add local video
            addLocalVideo();
            
            // Join session
            socket.emit('join_session', {
                session_id: sessionId,
                user_id: currentUser.id,
                user_name: currentUser.name,
                user_type: currentUser.type
            });
            
        } catch (error) {
            console.error('Failed to get user media:', error);
            showError('Failed to access camera/microphone: ' + error.message);
        }
    }
    
    function addLocalVideo() {
        const videoGrid = document.getElementById('videoGrid');
        const videoWrapper = document.createElement('div');
        videoWrapper.className = 'video-wrapper student';
        videoWrapper.id = 'local-video-wrapper';
        
        const video = document.createElement('video');
        video.id = 'local-video';
        video.srcObject = localStream;
        video.autoplay = true;
        video.muted = true;
        video.playsInline = true;
        
        const label = document.createElement('div');
        label.className = 'video-label';
        label.textContent = `${currentUser.name} (You)`;
        
        const controls = document.createElement('div');
        controls.className = 'video-controls';
        
        videoWrapper.appendChild(video);
        videoWrapper.appendChild(label);
        videoWrapper.appendChild(controls);
        videoGrid.appendChild(videoWrapper);
    }
    
    function addRemoteVideo(userId, stream, userName) {
        const videoGrid = document.getElementById('videoGrid');
        const existingVideo = document.getElementById(`remote-video-${userId}`);
        
        if (existingVideo) {
            existingVideo.srcObject = stream;
            return;
        }
        
        const videoWrapper = document.createElement('div');
        videoWrapper.className = 'video-wrapper teacher';
        videoWrapper.id = `remote-video-wrapper-${userId}`;
        
        const video = document.createElement('video');
        video.id = `remote-video-${userId}`;
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        
        const label = document.createElement('div');
        label.className = 'video-label';
        label.textContent = userName;
        
        videoWrapper.appendChild(video);
        videoWrapper.appendChild(label);
        videoGrid.appendChild(videoWrapper);
    }
    
    function removeRemoteVideo(userId) {
        const videoWrapper = document.getElementById(`remote-video-wrapper-${userId}`);
        if (videoWrapper) {
            videoWrapper.remove();
        }
    }
    
    // WebRTC Functions
    async function createPeerConnection(targetUserId) {
        const peerConnection = new RTCPeerConnection(rtcConfig);
        peerConnections.set(targetUserId, peerConnection);
        
        // Add local stream
        if (localStream) {
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }
        
        // Handle remote stream
        peerConnection.ontrack = (event) => {
            console.log('Received remote stream from:', targetUserId);
            const remoteStream = event.streams[0];
            remoteStreams.set(targetUserId, remoteStream);
            addRemoteVideo(targetUserId, remoteStream, 'Remote User');
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('webrtc_ice_candidate', {
                    session_id: sessionId,
                    target_user_id: targetUserId,
                    candidate: event.candidate,
                    from_user_id: currentUser.id
                });
            }
        };
        
        return peerConnection;
    }
    
    async function handleOffer(data) {
        try {
            const peerConnection = await createPeerConnection(data.from_user_id);
            await peerConnection.setRemoteDescription(data.offer);
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('webrtc_answer', {
                session_id: sessionId,
                target_user_id: data.from_user_id,
                answer: answer,
                from_user_id: currentUser.id
            });
            
        } catch (error) {
            console.error('Failed to handle offer:', error);
        }
    }
    
    async function handleAnswer(data) {
        try {
            const peerConnection = peerConnections.get(data.from_user_id);
            if (peerConnection) {
                await peerConnection.setRemoteDescription(data.answer);
            }
        } catch (error) {
            console.error('Failed to handle answer:', error);
        }
    }
    
    async function handleICECandidate(data) {
        try {
            const peerConnection = peerConnections.get(data.from_user_id);
            if (peerConnection) {
                await peerConnection.addIceCandidate(data.candidate);
            }
        } catch (error) {
            console.error('Failed to handle ICE candidate:', error);
        }
    }
    
    // Media Controls
    function toggleMicrophone() {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                isMuted = !audioTrack.enabled;
                
                const micBtn = document.getElementById('mic-btn');
                if (isMuted) {
                    micBtn.style.background = '#dc3545';
                    micBtn.innerHTML = 'üîá';
                } else {
                    micBtn.style.background = '#6c757d';
                    micBtn.innerHTML = 'üé§';
                }
            }
        }
    }
    
    function toggleCamera() {
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                isVideoOff = !videoTrack.enabled;
                
                const camBtn = document.getElementById('cam-btn');
                if (isVideoOff) {
                    camBtn.style.background = '#dc3545';
                    camBtn.innerHTML = 'üìπ';
                } else {
                    camBtn.style.background = '#6c757d';
                    camBtn.innerHTML = 'üìπ';
                }
            }
        }
    }
    
    function leaveSession() {
        if (confirm('Are you sure you want to leave the session?')) {
            // Stop all tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // Close all peer connections
            peerConnections.forEach(connection => connection.close());
            
            // Leave session
            socket.emit('leave_session', {
                session_id: sessionId,
                user_id: currentUser.id
            });
            
            // Redirect to dashboard
            window.location.href = '/api/student/dashboard';
        }
    }
    
    // Tab switching
    function switchTab(tabName) {
        // Hide all panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected panel
        document.getElementById(`${tabName}-panel`).classList.add('active');
        
        // Add active class to clicked tab
        event.target.classList.add('active');
    }
    
    function addParticipant(participant) {
        const participantsList = document.getElementById('participants-list');
        if (!participantsList) {
            console.error('Participants list element not found');
            return;
        }
        
        // Check if participant already exists
        const existingParticipant = document.getElementById(`participant-${participant.user_id}`);
        if (existingParticipant) {
            console.log('Participant already exists:', participant.user_name);
            return;
        }
        
        const participantDiv = document.createElement('div');
        participantDiv.className = `participant ${participant.user_type}`;
        participantDiv.id = `participant-${participant.user_id}`;
        
        const avatar = participant.user_name ? participant.user_name.charAt(0).toUpperCase() : '?';
        const userName = participant.user_name || 'Unknown User';
        const userType = participant.user_type || 'student';
        
        participantDiv.innerHTML = `
            <div class="participant-avatar">${avatar}</div>
            <div class="participant-info">
                <div class="participant-name">${userName}</div>
                <div class="participant-type">${userType}</div>
            </div>
        `;
        
        participantsList.appendChild(participantDiv);
        console.log('Added participant:', userName, 'Type:', userType);
        
        // Update participants count
        updateParticipantsCount();
    }
    
    function removeParticipant(userId) {
        const participant = document.getElementById(`participant-${userId}`);
        if (participant) {
            participant.remove();
        }
        
        // Remove peer connection
        const peerConnection = peerConnections.get(userId);
        if (peerConnection) {
            peerConnection.close();
            peerConnections.delete(userId);
        }
        
        // Remove remote stream
        remoteStreams.delete(userId);
        
        // Remove remote video
        removeRemoteVideo(userId);
        
        // Update participants count
        updateParticipantsCount();
    }
    
    function updateParticipantsCount() {
        const count = document.querySelectorAll('.participant').length;
        document.getElementById('participants-count').textContent = `üë• ${count} participants`;
    }
    
    function addChatMessage(userName, message, timestamp, isOwn = false) {
        const chatMessages = document.getElementById('chat-messages');
        
        // Clear "no messages" placeholder if it exists
        const placeholder = chatMessages.querySelector('.text-center');
        if (placeholder) {
            placeholder.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
        
        const time = new Date(timestamp).toLocaleTimeString();
        
        messageDiv.innerHTML = `
            <div class="message-header">${userName} ‚Ä¢ ${time}</div>
            <div>${message}</div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (message && socket) {
            console.log('Sending chat message:', message);
            socket.emit('chat_message', {
                session_id: sessionId,
                message: message,
                user_id: currentUser.id,
                user_name: currentUser.name
            });
            
            // Add message to chat immediately for better UX
            addChatMessage(currentUser.name, message, new Date().toISOString(), true);
            input.value = '';
        }
    }
    
    function handleChatKeypress(event) {
        if (event.key === 'Enter') {
            sendChatMessage();
        }
    }
    
    // Whiteboard Functions
    function initializeWhiteboard() {
        whiteboardCanvas = document.getElementById('whiteboard-canvas');
        whiteboardCtx = whiteboardCanvas.getContext('2d');
        
        setupWhiteboardEventListeners();
    }
    
    function setupWhiteboardEventListeners() {
        // Mouse events
        whiteboardCanvas.addEventListener('mousedown', startDrawing);
        whiteboardCanvas.addEventListener('mousemove', draw);
        whiteboardCanvas.addEventListener('mouseup', stopDrawing);
        whiteboardCanvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        whiteboardCanvas.addEventListener('touchstart', handleTouch);
        whiteboardCanvas.addEventListener('touchmove', handleTouch);
        whiteboardCanvas.addEventListener('touchend', stopDrawing);
    }
    
    function startDrawing(e) {
        isDrawing = true;
        const rect = whiteboardCanvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    }
    
    function draw(e) {
        if (!isDrawing) return;
        
        const rect = whiteboardCanvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        whiteboardCtx.beginPath();
        whiteboardCtx.moveTo(lastX, lastY);
        whiteboardCtx.lineTo(currentX, currentY);
        whiteboardCtx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : currentColor;
        whiteboardCtx.lineWidth = currentTool === 'eraser' ? brushSize * 3 : brushSize;
        whiteboardCtx.lineCap = 'round';
        whiteboardCtx.lineJoin = 'round';
        whiteboardCtx.stroke();
        
        // Broadcast drawing data to other participants
        if (socket) {
            socket.emit('whiteboard_draw', {
                session_id: sessionId,
                drawing_data: {
                    fromX: lastX,
                    fromY: lastY,
                    toX: currentX,
                    toY: currentY,
                    color: currentTool === 'eraser' ? '#ffffff' : currentColor,
                    lineWidth: currentTool === 'eraser' ? brushSize * 3 : brushSize,
                    tool: currentTool
                }
            });
        }
        
        lastX = currentX;
        lastY = currentY;
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                         e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        whiteboardCanvas.dispatchEvent(mouseEvent);
    }
    
    function setWhiteboardTool(tool) {
        currentTool = tool;
        
        // Update button states
        document.getElementById('pen-tool').classList.toggle('active', tool === 'pen');
        document.getElementById('eraser-tool').classList.toggle('active', tool === 'eraser');
        
        // Update cursor
        whiteboardCanvas.style.cursor = tool === 'eraser' ? 'grab' : 'crosshair';
    }
    
    function setWhiteboardColor(color) {
        currentColor = color;
    }
    
    function setBrushSize(size) {
        brushSize = parseInt(size);
    }
    
    function clearWhiteboard() {
        if (whiteboardCtx) {
            whiteboardCtx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
            
            // Broadcast clear event to other participants
            if (socket) {
                socket.emit('whiteboard_clear', {
                    session_id: sessionId
                });
            }
            
            showAlert('Whiteboard cleared', 'success');
        }
    }
    
    function drawRemoteWhiteboard(drawingData) {
        if (!whiteboardCtx) return;
        
        whiteboardCtx.beginPath();
        whiteboardCtx.moveTo(drawingData.fromX, drawingData.fromY);
        whiteboardCtx.lineTo(drawingData.toX, drawingData.toY);
        whiteboardCtx.strokeStyle = drawingData.color;
        whiteboardCtx.lineWidth = drawingData.lineWidth;
        whiteboardCtx.lineCap = 'round';
        whiteboardCtx.lineJoin = 'round';
        whiteboardCtx.stroke();
    }
    
    // Utility Functions
    function showAlert(message, type) {
        const alert = document.getElementById('alert');
        alert.textContent = message;
        alert.className = `alert alert-${type === 'error' ? 'danger' : type}`;
        alert.style.display = 'block';
        
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }
    
    function showError(message) {
        showAlert(message, 'error');
    }
</script>
</body>
</html>
