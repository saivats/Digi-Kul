<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Digi Kul</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bs-body-bg: #1a1a1a;
            --bs-body-color: #e9ecef;
            --bs-dark: #212529;
            --bs-secondary: #6c757d;
        }
        
        body {
            background-color: #1a1a1a !important;
            color: #e9ecef !important;
        }
        
        .navbar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
            border-bottom: 1px solid #495057;
        }
        
        .card {
            background-color: #2d3748 !important;
            border: 1px solid #495057 !important;
            color: #e9ecef !important;
        }
        
        .card-header {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%) !important;
            border-bottom: 1px solid #495057 !important;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #495057 !important;
        }
        
        .nav-tabs .nav-link {
            color: #adb5bd !important;
            border: 1px solid transparent !important;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #495057 #495057 #495057 !important;
            color: #e9ecef !important;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-color: #495057 #495057 #2d3748 !important;
        }
        
        .form-control {
            background-color: #495057 !important;
            border: 1px solid #6c757d !important;
            color: #e9ecef !important;
        }
        
        .form-control:focus {
            background-color: #495057 !important;
            border-color: #667eea !important;
            color: #e9ecef !important;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
        }
        
        .btn-outline-light {
            border-color: #6c757d !important;
            color: #e9ecef !important;
        }
        
        .btn-outline-light:hover {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: #fff !important;
        }
        
        .table {
            color: #e9ecef !important;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: rgba(73, 80, 87, 0.3) !important;
        }
        
        .modal-content {
            background-color: #2d3748 !important;
            color: #e9ecef !important;
        }
        
        .modal-header {
            border-bottom: 1px solid #495057 !important;
        }
        
        .modal-footer {
            border-top: 1px solid #495057 !important;
        }
        
        .toast {
            background-color: #2d3748 !important;
            color: #e9ecef !important;
        }
        
        .toast-header {
            background-color: #495057 !important;
            color: #e9ecef !important;
            border-bottom: 1px solid #6c757d !important;
        }
        
        .text-muted {
            color: #adb5bd !important;
        }
        
        .bg-light {
            background-color: #495057 !important;
        }
        
        .border {
            border-color: #495057 !important;
        }
    </style>
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <style>
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chatbot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        
        .message.user .message-avatar {
            background: #007bff;
        }
        
        .message.asha .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .message-content {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message.user .message-content {
            background: #007bff;
            color: white;
        }
        
        .message.asha .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
        }
        
        /* Fix text visibility on dark backgrounds */
        .card-text, .text-muted, .card-title {
            color: #333 !important;
        }
        
        .card-body {
            background: #fff;
            color: #333;
        }
        
        .card {
            background: #fff;
            border: 1px solid #dee2e6;
        }
        
        .badge {
            color: #fff !important;
        }
        
        .chatbot-input {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }
        
        .chatbot-input input {
            flex: 1;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            padding: 10px 15px;
            outline: none;
        }
        
        .chatbot-input button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
        }
        
        .welcome-message {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .welcome-message .asha-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin: 0 auto 15px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-mortarboard me-2"></i>
                Digi Kul - Student Portal
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    Welcome, <strong id="studentName">Student</strong>
                </span>
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Enrolled Cohorts</h6>
                                <h3 id="enrolledCohorts">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-people-fill fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Upcoming Lectures</h6>
                                <h3 id="upcomingLectures">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-calendar-event fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Available Quizzes</h6>
                                <h3 id="availableQuizzes">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-question-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Materials</h6>
                                <h3 id="availableMaterials">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-file-earmark-text fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" style="border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button class="btn w-100 text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" onclick="showEnrollModal()">
                                    <i class="bi bi-plus-circle me-2"></i>Enroll in Cohort
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn w-100 text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" onclick="loadLectures()">
                                    <i class="bi bi-calendar-event me-2"></i>View Lectures
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn w-100 text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" onclick="loadMaterials()">
                                    <i class="bi bi-download me-2"></i>Download Materials
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn w-100 text-white" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" onclick="toggleChatbot()">
                                    <i class="bi bi-chat-dots me-2"></i>Ask Asha
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist" style="border-bottom: 2px solid #e9ecef;">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="cohorts-tab" data-bs-toggle="tab" data-bs-target="#cohorts" type="button" role="tab" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-people me-2"></i>My Cohorts
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="lectures-tab" data-bs-toggle="tab" data-bs-target="#lectures" type="button" role="tab" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-calendar-event me-2"></i>Lectures
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-file-earmark-text me-2"></i>Materials
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quizzes-tab" data-bs-toggle="tab" data-bs-target="#quizzes" type="button" role="tab" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-question-circle me-2"></i>Quizzes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="polls-tab" data-bs-toggle="tab" data-bs-target="#polls" type="button" role="tab" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-bar-chart me-2"></i>Polls
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="discussions-tab" data-bs-toggle="tab" data-bs-target="#discussions" type="button" role="tab" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-chat-dots me-2"></i>Discussions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="grades-tab" data-bs-toggle="tab" data-bs-target="#grades" type="button" role="tab" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-award me-2"></i>Grades
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recordings-tab" data-bs-toggle="tab" data-bs-target="#recordings" type="button" role="tab" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; margin-right: 5px; border-radius: 10px 10px 0 0;">
                    <i class="bi bi-play-circle me-2"></i>Recordings
                </button>
            </li>
        </ul>

        <div class="tab-content" id="dashboardTabContent">
            <!-- Cohorts Tab -->
            <div class="tab-pane fade show active" id="cohorts" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">My Cohorts</h5>
                        <button class="btn btn-primary" onclick="showEnrollModal()">
                            <i class="bi bi-plus-circle me-2"></i>Enroll in Cohort
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="cohortsList">
                            <div class="text-center py-4">
                                <i class="bi bi-people fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No cohorts enrolled yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lectures Tab -->
            <div class="tab-pane fade" id="lectures" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Upcoming Lectures</h5>
                    </div>
                    <div class="card-body">
                        <div id="lecturesList">
                            <div class="text-center py-4">
                                <i class="bi bi-calendar-event fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No upcoming lectures</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Materials Tab -->
            <div class="tab-pane fade" id="materials" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Available Materials</h5>
                    </div>
                    <div class="card-body">
                        <div id="materialsList">
                            <div class="text-center py-4">
                                <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No materials available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quizzes Tab -->
            <div class="tab-pane fade" id="quizzes" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Available Quizzes</h5>
                    </div>
                    <div class="card-body">
                        <div id="quizzesList">
                            <div class="text-center py-4">
                                <i class="bi bi-question-circle fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No quizzes available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Polls Tab -->
            <div class="tab-pane fade" id="polls" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Active Polls</h5>
                    </div>
                    <div class="card-body">
                        <div id="pollsList">
                            <div class="text-center py-4">
                                <i class="bi bi-bar-chart fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No polls available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussions Tab -->
            <div class="tab-pane fade" id="discussions" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Cohort Discussions</h5>
                    </div>
                    <div class="card-body">
                        <div id="discussionsList">
                            <div class="text-center py-4">
                                <i class="bi bi-chat-dots fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No discussions available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grades Tab -->
            <div class="tab-pane fade" id="grades" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">My Grades</h5>
                    </div>
                    <div class="card-body">
                        <div id="gradesList">
                            <div class="text-center py-4">
                                <i class="bi bi-award fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No grades available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recordings Tab -->
            <div class="tab-pane fade" id="recordings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Recorded Lectures</h5>
                    </div>
                    <div class="card-body">
                        <div id="recordingsList">
                            <div class="text-center py-4">
                                <i class="bi bi-play-circle fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No recordings available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enroll in Cohort Modal -->
    <div class="modal fade" id="enrollModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Enroll in Cohort</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="enrollForm">
                        <div class="mb-3">
                            <label class="form-label">Enrollment Code</label>
                            <input type="text" class="form-control" id="enrollmentCode" placeholder="Enter cohort enrollment code" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="enrollInCohort()">Enroll</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Asha Chatbot -->
    <div class="chatbot-container">
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="chatbot-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <div>
                    <h6 class="mb-0">Asha - Your AI Assistant</h6>
                    <small>Online</small>
                </div>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="welcome-message">
                    <div class="asha-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <h6>Hi! I'm Asha üëã</h6>
                    <p>Your AI learning assistant. I'm here to help you with:</p>
                    <ul class="list-unstyled">
                        <li>üìö Study questions</li>
                        <li>üí° Learning tips</li>
                        <li>üîç Course content help</li>
                        <li>üìù Assignment guidance</li>
                    </ul>
                    <p>How can I help you today?</p>
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" placeholder="Ask me anything..." onkeypress="handleChatbotKeypress(event)">
                <button onclick="sendMessage()">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
        <button class="chatbot-toggle" onclick="toggleChatbot()">
            <i class="bi bi-chat-dots"></i>
        </button>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <script>
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="bi bi-${type === 'success' ? 'check-circle-fill text-success' : 
                                           type === 'error' ? 'exclamation-triangle-fill text-danger' : 
                                           type === 'warning' ? 'exclamation-triangle-fill text-warning' : 
                                           'info-circle-fill text-info'} me-2"></i>
                        <strong class="me-auto">DigiKul</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <script>
        // Global variables
        let chatbotOpen = false;
        let studentData = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentData();
            loadDashboardData();
        });

        async function loadStudentData() {
            try {
                const response = await fetch('/api/student/profile');
                const data = await response.json();
                
                if (data.success) {
                    studentData = data.student;
                    document.getElementById('studentName').textContent = studentData.name;
                }
            } catch (error) {
                console.error('Error loading student data:', error);
            }
        }

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadCohorts(),
                    loadLectures(),
                    loadMaterials(),
                    loadQuizzes(),
                    loadPolls(),
                    loadDiscussions(),
                    loadGrades(),
                    loadRecordings()
                ]);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadCohorts() {
            try {
                const response = await fetch('/api/student/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohorts = data.cohorts;
                    document.getElementById('enrolledCohorts').textContent = cohorts.length;
                    renderCohorts(cohorts);
                }
            } catch (error) {
                console.error('Error loading cohorts:', error);
            }
        }

        async function loadLectures() {
            try {
                // Switch to lectures tab
                const lecturesTab = new bootstrap.Tab(document.getElementById('lectures-tab'));
                lecturesTab.show();
                
                const response = await fetch('/api/student/lectures');
                const data = await response.json();
                
                if (data.success) {
                    const lectures = data.lectures;
                    document.getElementById('upcomingLectures').textContent = lectures.length;
                    renderLectures(lectures);
                }
            } catch (error) {
                console.error('Error loading lectures:', error);
            }
        }

        async function loadMaterials() {
            try {
                // Switch to materials tab
                const materialsTab = new bootstrap.Tab(document.getElementById('materials-tab'));
                materialsTab.show();
                
                const response = await fetch('/api/student/materials');
                const data = await response.json();
                
                if (data.success) {
                    const materials = data.materials;
                    document.getElementById('availableMaterials').textContent = materials.length;
                    renderMaterials(materials);
                }
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        async function loadQuizzes() {
            try {
                const response = await fetch('/api/student/quizzes');
                const data = await response.json();
                
                if (data.success) {
                    const quizSets = data.quiz_sets;
                    document.getElementById('availableQuizzes').textContent = quizSets.length;
                    renderQuizzes(quizSets);
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
            }
        }

        function renderCohorts(cohorts) {
            const container = document.getElementById('cohortsList');
            
            if (cohorts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-people fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No cohorts enrolled yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cohorts.map(cohort => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${cohort.name}</h6>
                        <p class="card-text text-muted">${cohort.description || 'No description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>
                                ${cohort.academic_year || 'N/A'}
                            </small>
                            <span class="badge bg-success">Enrolled</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderLectures(lectures) {
            const container = document.getElementById('lecturesList');
            
            if (lectures.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-event fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No upcoming lectures</p>
                    </div>
                `;
                return;
            }
            
            const now = new Date();
            
            container.innerHTML = lectures.map(lecture => {
                const lectureTime = new Date(lecture.scheduled_time);
                const endTime = new Date(lectureTime.getTime() + (lecture.duration * 60000));
                const isLive = now >= lectureTime && now <= endTime;
                const isUpcoming = now < lectureTime;
                const isPast = now > endTime;
                
                let statusBadge = '';
                let actionButton = '';
                
                if (isLive) {
                    statusBadge = '<span class="badge bg-danger me-2">LIVE</span>';
                    actionButton = `<button class="btn btn-sm btn-success" onclick="joinLiveSession('${lecture.id}')">
                        <i class="bi bi-play-circle me-1"></i>Join Live
                    </button>`;
                } else if (isUpcoming) {
                    statusBadge = '<span class="badge bg-warning me-2">Upcoming</span>';
                    actionButton = `<button class="btn btn-sm btn-secondary" disabled>
                        <i class="bi bi-clock me-1"></i>Not Started
                    </button>`;
                } else {
                    statusBadge = '<span class="badge bg-secondary me-2">Ended</span>';
                    actionButton = `<button class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="bi bi-check-circle me-1"></i>Completed
                    </button>`;
                }
                
                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${lecture.title}</h6>
                            <p class="card-text text-muted">${lecture.description || 'No description'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    ${lectureTime.toLocaleString()}
                                </small>
                                <div>
                                    <span class="badge bg-primary me-2">${lecture.duration} min</span>
                                    ${statusBadge}
                                    ${actionButton}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materialsList');
            
            if (materials.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No materials available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = materials.map(material => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${material.title}</h6>
                        <p class="card-text text-muted">${material.description || 'No description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-file-earmark me-1"></i>
                                ${material.file_name}
                            </small>
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadMaterial('${material.id}')">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderQuizzes(quizSets) {
            const container = document.getElementById('quizzesList');
            
            if (quizSets.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-question-circle fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No quizzes available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = quizSets.map(quiz => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${quiz.title}</h6>
                        <p class="card-text text-muted">${quiz.description || 'No description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${quiz.time_limit ? quiz.time_limit + ' min' : 'No time limit'}
                            </small>
                            <button class="btn btn-sm btn-primary" onclick="startQuiz('${quiz.id}')">
                                <i class="bi bi-play me-1"></i>Start Quiz
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showEnrollModal() {
            new bootstrap.Modal(document.getElementById('enrollModal')).show();
        }

        async function enrollInCohort() {
            const enrollmentCode = document.getElementById('enrollmentCode').value;
            
            if (!enrollmentCode) {
                showToast('Please enter an enrollment code', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/student/enroll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enrollment_code: enrollmentCode })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Successfully enrolled in cohort!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('enrollModal')).hide();
                    document.getElementById('enrollForm').reset();
                    loadCohorts();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                console.error('Error enrolling in cohort:', error);
                showToast('Error enrolling in cohort', 'error');
            }
        }

        // Chatbot Functions
        function toggleChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            chatbotOpen = !chatbotOpen;
            
            if (chatbotOpen) {
                chatbotWindow.style.display = 'flex';
            } else {
                chatbotWindow.style.display = 'none';
            }
        }

        function handleChatbotKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Get AI response
                const response = await generateAshaResponse(message);
                hideTypingIndicator();
                addMessage(response, 'asha');
            } catch (error) {
                hideTypingIndicator();
                addMessage('Sorry, I encountered an error. Please try again.', 'asha');
            }
        }

        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? 
                '<i class="bi bi-person-fill"></i>' : 
                '<i class="bi bi-robot"></i>';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatbotMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message asha';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar"><i class="bi bi-robot"></i></div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function generateAshaResponse(userMessage) {
            try {
                // Check if API keys are configured
                const response = await fetch('/api/student/chatbot/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: userMessage,
                        user_id: currentUser.id,
                        user_name: currentUser.name
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.response) {
                        return data.response;
                    }
                }
                
                // Fallback to simple responses if API is not available
                return generateFallbackResponse(userMessage);
                
            } catch (error) {
                console.error('Chatbot API error:', error);
                return generateFallbackResponse(userMessage);
            }
        }
        
        function generateFallbackResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // Simple response patterns
            if (message.includes('hello') || message.includes('hi')) {
                return "Hello! üëã I'm Asha, your AI learning assistant. How can I help you with your studies today?";
            }
            
            if (message.includes('help') || message.includes('assist')) {
                return "I'm here to help! I can assist you with:\n‚Ä¢ Explaining course concepts\n‚Ä¢ Study tips and strategies\n‚Ä¢ Assignment guidance\n‚Ä¢ Quiz preparation\n‚Ä¢ General learning questions\n\nWhat would you like to know?";
            }
            
            if (message.includes('study') || message.includes('learn')) {
                return "Great! Here are some effective study tips:\n\nüìö **Active Learning**:\n‚Ä¢ Take notes while reading\n‚Ä¢ Summarize in your own words\n‚Ä¢ Teach others what you've learned\n\n‚è∞ **Time Management**:\n‚Ä¢ Use the Pomodoro Technique (25 min focus, 5 min break)\n‚Ä¢ Create a study schedule\n‚Ä¢ Prioritize difficult topics\n\nüß† **Memory Techniques**:\n‚Ä¢ Use spaced repetition\n‚Ä¢ Create mind maps\n‚Ä¢ Practice retrieval\n\nWould you like me to elaborate on any of these techniques?";
            }
            
            if (message.includes('quiz') || message.includes('test') || message.includes('exam')) {
                return "Quiz preparation tips! üéØ\n\n**Before the Quiz**:\n‚Ä¢ Review all course materials\n‚Ä¢ Practice with sample questions\n‚Ä¢ Get a good night's sleep\n‚Ä¢ Eat a healthy meal\n\n**During the Quiz**:\n‚Ä¢ Read questions carefully\n‚Ä¢ Answer easy questions first\n‚Ä¢ Manage your time wisely\n‚Ä¢ Stay calm and focused\n\n**After the Quiz**:\n‚Ä¢ Review your answers if time permits\n‚Ä¢ Learn from mistakes\n‚Ä¢ Ask for feedback\n\nNeed help with specific quiz topics?";
            }
            
            if (message.includes('assignment') || message.includes('homework')) {
                return "Assignment help! üìù\n\n**Getting Started**:\n‚Ä¢ Read instructions carefully\n‚Ä¢ Break down into smaller tasks\n‚Ä¢ Create a timeline\n‚Ä¢ Gather resources\n\n**Writing Tips**:\n‚Ä¢ Start with an outline\n‚Ä¢ Use clear, concise language\n‚Ä¢ Support arguments with evidence\n‚Ä¢ Proofread before submitting\n\n**Common Pitfalls to Avoid**:\n‚Ä¢ Procrastination\n‚Ä¢ Plagiarism\n‚Ä¢ Poor time management\n‚Ä¢ Not following instructions\n\nWhat specific assignment are you working on?";
            }
            
            if (message.includes('thank') || message.includes('thanks')) {
                return "You're very welcome! üòä I'm always here to help with your learning journey. Feel free to ask me anything about your studies!";
            }
            
            // Default response
            return "That's an interesting question! ü§î While I'm still learning, I can help you with study strategies, exam preparation, assignment guidance, and general learning tips. Could you be more specific about what you'd like help with?";
        }

        async function logout() {
            try {
                const response = await fetch('/api/student/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        async function downloadMaterial(materialId) {
            try {
                const response = await fetch(`/api/student/materials/${materialId}/download`);
                
                if (response.ok) {
                    // If it's a redirect to Supabase Storage, the browser will handle it
                    if (response.redirected) {
                        window.open(response.url, '_blank');
                    } else {
                        // For local files, trigger download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `material_${materialId}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }
                    showToast('Material downloaded successfully!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to download material', 'error');
                }
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download material', 'error');
            }
        }

        async function startQuiz(quizId) {
            try {
                // Redirect to quiz attempt page
                window.location.href = `/api/student/quiz-attempt/${quizId}`;
            } catch (error) {
                console.error('Quiz start error:', error);
                showToast('Failed to start quiz', 'error');
            }
        }

        // Additional loading functions
        async function loadPolls() {
            try {
                const response = await fetch('/api/student/polls');
                const data = await response.json();
                
                if (data.success) {
                    renderPolls(data.polls);
                }
            } catch (error) {
                console.error('Error loading polls:', error);
            }
        }

        async function loadDiscussions() {
            try {
                const response = await fetch('/api/student/discussions');
                const data = await response.json();
                
                if (data.success) {
                    renderDiscussions(data.discussions);
                }
            } catch (error) {
                console.error('Error loading discussions:', error);
            }
        }

        async function loadGrades() {
            try {
                const response = await fetch('/api/student/grades');
                const data = await response.json();
                
                if (data.success) {
                    renderGrades(data.grades);
                }
            } catch (error) {
                console.error('Error loading grades:', error);
            }
        }

        async function loadRecordings() {
            try {
                const response = await fetch('/api/student/recordings');
                const data = await response.json();
                
                if (data.success) {
                    renderRecordings(data.recordings);
                }
            } catch (error) {
                console.error('Error loading recordings:', error);
            }
        }

        function renderPolls(polls) {
            const container = document.getElementById('pollsList');
            
            if (polls.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-bar-chart fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No polls available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = polls.map(poll => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${poll.question}</h6>
                        <div class="mb-3">
                            ${poll.options.map((option, index) => `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="poll_${poll.id}" id="option_${poll.id}_${index}" value="${option}">
                                    <label class="form-check-label" for="option_${poll.id}_${index}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${new Date(poll.created_at).toLocaleDateString()}
                            </small>
                            <div>
                                <button class="btn btn-sm btn-primary me-2" onclick="votePoll('${poll.id}')">Vote</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewPollResults('${poll.id}')">Results</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderDiscussions(discussions) {
            const container = document.getElementById('discussionsList');
            
            if (discussions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-chat-dots fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No discussions available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = discussions.map(discussion => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${discussion.title}</h6>
                        <p class="card-text text-muted">${discussion.description || 'No description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-people me-1"></i>
                                ${discussion.cohort_name || 'Unknown Cohort'}
                            </small>
                            <button class="btn btn-sm btn-primary" onclick="viewDiscussion('${discussion.id}')">
                                <i class="bi bi-chat-dots me-1"></i>View Discussion
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderGrades(grades) {
            const container = document.getElementById('gradesList');
            
            if (grades.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-award fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No grades available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = grades.map(grade => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${grade.lecture_title || 'Assignment'}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Grade:</strong> ${grade.grade}/${grade.max_grade}</p>
                                <p class="mb-1"><strong>Percentage:</strong> ${grade.percentage.toFixed(1)}%</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Type:</strong> ${grade.grade_type}</p>
                                <p class="mb-1"><strong>Date:</strong> ${new Date(grade.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                        ${grade.comments ? `<p class="mt-2"><strong>Comments:</strong> ${grade.comments}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderRecordings(recordings) {
            const container = document.getElementById('recordingsList');
            
            if (recordings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-play-circle fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No recordings available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recordings.map(recording => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${recording.title || 'Lecture Recording'}</h6>
                        <p class="card-text text-muted">${recording.description || 'No description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${recording.duration ? Math.floor(recording.duration / 60) + ' min' : 'Unknown duration'}
                                <span class="ms-3">
                                    <i class="bi bi-download me-1"></i>
                                    ${recording.download_count || 0} downloads
                                </span>
                            </small>
                            <button class="btn btn-sm btn-primary" onclick="downloadRecording('${recording.id}')">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Additional functionality
        async function votePoll(pollId) {
            const selectedOption = document.querySelector(`input[name="poll_${pollId}"]:checked`);
            if (!selectedOption) {
                showToast('Please select an option', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/student/polls/${pollId}/vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ selected_option: selectedOption.value })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Vote submitted successfully!', 'success');
                    loadPolls(); // Refresh polls
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                console.error('Vote error:', error);
                showToast('Failed to submit vote', 'error');
            }
        }

        async function viewPollResults(pollId) {
            try {
                const response = await fetch(`/api/student/polls/${pollId}/results`);
                const data = await response.json();
                
                if (data.success) {
                    // Show results in a modal or new page
                    showToast('Poll results loaded', 'info');
                    // Implement results display
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                console.error('Results error:', error);
                showToast('Failed to load results', 'error');
            }
        }

        function viewDiscussion(forumId) {
            // Navigate to discussion page
            window.location.href = `/api/student/discussion/${forumId}`;
        }

        async function joinLiveSession(lectureId) {
            try {
                const response = await fetch(`/api/student/live-session/${lectureId}`);
                
                if (response.ok) {
                    // Redirect to live session
                    window.location.href = `/api/student/live-session/${lectureId}`;
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to join live session', 'error');
                }
            } catch (error) {
                console.error('Join live session error:', error);
                showToast('Failed to join live session', 'error');
            }
        }

        async function downloadRecording(recordingId) {
            try {
                const response = await fetch(`/api/student/recordings/${recordingId}/download`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recording_${recordingId}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast('Recording downloaded successfully!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to download recording', 'error');
                }
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download recording', 'error');
            }
        }
    </script>
</body>
</html>