<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Digi Kul</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-mortarboard me-2"></i>
                Digi Kul - Teacher Portal
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    Welcome, <strong id="teacherName">Teacher</strong>
                </span>
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">My Lectures</h6>
                                <h3 id="myLectures">{{ stats.lectures if stats else 0 }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-calendar-event fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">My Cohorts</h6>
                                <h3 id="myCohorts">{{ stats.cohorts if stats else 0 }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-people-fill fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Materials</h6>
                                <h3 id="myMaterials">{{ stats.materials if stats else 0 }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-file-earmark-text fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Students</h6>
                                <h3 id="totalStudents">{{ stats.students if stats else 0 }}</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-person-check fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-primary w-100" onclick="showCreateLectureModal()">
                                    <i class="bi bi-plus-circle me-2"></i>Create Lecture
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-success w-100" onclick="showUploadMaterialModal()">
                                    <i class="bi bi-upload me-2"></i>Upload Material
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-warning w-100" onclick="showCreateQuizModal()">
                                    <i class="bi bi-question-circle me-2"></i>Create Quiz
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-info w-100" onclick="viewAnalytics()">
                                    <i class="bi bi-graph-up me-2"></i>View Analytics
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="lectures-tab" data-bs-toggle="tab" data-bs-target="#lectures" type="button" role="tab">
                    <i class="bi bi-calendar-event me-2"></i>My Lectures
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cohorts-tab" data-bs-toggle="tab" data-bs-target="#cohorts" type="button" role="tab">
                    <i class="bi bi-people me-2"></i>My Cohorts
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab">
                    <i class="bi bi-file-earmark-text me-2"></i>Materials
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="discussions-tab" data-bs-toggle="tab" data-bs-target="#discussions" type="button" role="tab">
                    <i class="bi bi-chat-dots me-2"></i>Discussions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="polls-tab" data-bs-toggle="tab" data-bs-target="#polls" type="button" role="tab">
                    <i class="bi bi-bar-chart me-2"></i>Polls
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quizzes-tab" data-bs-toggle="tab" data-bs-target="#quizzes" type="button" role="tab">
                    <i class="bi bi-question-circle me-2"></i>Quizzes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recordings-tab" data-bs-toggle="tab" data-bs-target="#recordings" type="button" role="tab">
                    <i class="bi bi-camera-video me-2"></i>Recorded Lectures
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                    <i class="bi bi-person me-2"></i>Profile
                </button>
            </li>
        </ul>

        <div class="tab-content" id="dashboardTabContent">
            <!-- Lectures Tab -->
            <div class="tab-pane fade show active" id="lectures" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">My Lectures</h5>
                        <button class="btn btn-primary" onclick="showCreateLectureModal()">
                            <i class="bi bi-plus-circle me-2"></i>Create Lecture
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="lecturesList">
                            <div class="text-center py-4">
                                <i class="bi bi-calendar-event fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No lectures created yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cohorts Tab -->
            <div class="tab-pane fade" id="cohorts" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">My Cohorts</h5>
                    </div>
                    <div class="card-body">
                        <div id="cohortsList">
                            <div class="text-center py-4">
                                <i class="bi bi-people fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No cohorts assigned</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Materials Tab -->
            <div class="tab-pane fade" id="materials" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">My Materials</h5>
                        <button class="btn btn-primary" onclick="showUploadMaterialModal()">
                            <i class="bi bi-upload me-2"></i>Upload Material
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="materialsList">
                            <div class="text-center py-4">
                                <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No materials uploaded yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discussions Tab -->
            <div class="tab-pane fade" id="discussions" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Cohort Discussions</h5>
                        <button class="btn btn-primary btn-sm" onclick="showCreateDiscussionModal()">
                            <i class="bi bi-plus-circle me-1"></i>Start Discussion
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="discussionsList">
                            <div class="text-center py-4">
                                <i class="bi bi-chat-dots fs-1 text-muted"></i>
                                <p class="text-muted mt-2">Loading discussions...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Polls Tab -->
            <div class="tab-pane fade" id="polls" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Polls</h5>
                        <button class="btn btn-primary btn-sm" onclick="showCreatePollModal()">
                            <i class="bi bi-plus-circle me-1"></i>Create Poll
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pollsList">
                            <div class="text-center py-4">
                                <i class="bi bi-bar-chart fs-1 text-muted"></i>
                                <p class="text-muted mt-2">Loading polls...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quizzes Tab -->
            <div class="tab-pane fade" id="quizzes" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Quizzes</h5>
                        <button class="btn btn-primary btn-sm" onclick="showCreateQuizModal()">
                            <i class="bi bi-plus-circle me-1"></i>Create Quiz
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="quizzesList">
                            <div class="text-center py-4">
                                <i class="bi bi-question-circle fs-1 text-muted"></i>
                                <p class="text-muted mt-2">Loading quizzes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recorded Lectures Tab -->
            <div class="tab-pane fade" id="recordings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Recorded Lectures</h5>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="recordingCohortFilter" class="form-label">Cohort</label>
                                <select class="form-select" id="recordingCohortFilter">
                                    <option value="">All Cohorts</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="recordingDateFrom" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="recordingDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="recordingDateTo" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="recordingDateTo">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" onclick="filterRecordings()">
                                        <i class="bi bi-funnel me-1"></i>Filter
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearRecordingFilters()">
                                        <i class="bi bi-x-circle me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Recording Button -->
                        <div class="mb-3">
                            <button class="btn btn-success" onclick="showUploadRecordingModal()">
                                <i class="bi bi-cloud-upload me-1"></i>Upload Recording
                            </button>
                        </div>
                        
                        <!-- Recordings List -->
                        <div id="recordingsList">
                            <div class="text-center py-4">
                                <i class="bi bi-camera-video fs-1 text-muted"></i>
                                <p class="text-muted mt-2">Loading recordings...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-pane fade" id="profile" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">My Profile</h5>
                    </div>
                    <div class="card-body">
                        <div id="profileContent">
                            <div class="text-center py-4">
                                <i class="bi bi-person fs-1 text-muted"></i>
                                <p class="text-muted mt-2">Loading profile...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <script>
        // Global variables
        let teacherData = {};

        // Recording Functions
        async function loadRecordings() {
            try {
                const response = await fetch('/api/teacher/recorded-lectures');
                const data = await response.json();
                
                if (data.success) {
                    renderRecordings(data.recordings);
                    populateCohortFilter(data.cohorts);
                } else {
                    console.error('Failed to load recordings:', data.error);
                    showToast('Failed to load recordings', 'error');
                }
            } catch (error) {
                console.error('Error loading recordings:', error);
                showToast('Error loading recordings', 'error');
            }
        }

        function renderRecordings(recordings) {
            const container = document.getElementById('recordingsList');
            
            if (recordings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-camera-video fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No recorded lectures found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recordings.map(recording => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="card-title">${recording.lectures?.title || 'Untitled Lecture'}</h6>
                                <p class="card-text text-white-50">
                                    <i class="bi bi-people me-1"></i>Cohort: ${recording.cohorts?.name || 'Unknown'}
                                </p>
                                <p class="card-text text-white-50">
                                    <i class="bi bi-calendar me-1"></i>Recorded: ${new Date(recording.created_at).toLocaleString()}
                                </p>
                                <p class="card-text text-white-50">
                                    <i class="bi bi-download me-1"></i>Downloads: ${recording.download_count || 0}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group-vertical">
                                    <button class="btn btn-outline-primary btn-sm mb-2" onclick="downloadRecording('${recording.id}')">
                                        <i class="bi bi-download me-1"></i>Download
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewRecordingDetails('${recording.id}')">
                                        <i class="bi bi-eye me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function populateCohortFilter(cohorts) {
            const select = document.getElementById('recordingCohortFilter');
            select.innerHTML = '<option value="">All Cohorts</option>';
            
            cohorts.forEach(cohort => {
                const option = document.createElement('option');
                option.value = cohort.id;
                option.textContent = cohort.name;
                select.appendChild(option);
            });
        }

        async function filterRecordings() {
            try {
                const cohortId = document.getElementById('recordingCohortFilter').value;
                const dateFrom = document.getElementById('recordingDateFrom').value;
                const dateTo = document.getElementById('recordingDateTo').value;
                
                let url = '/api/teacher/recorded-lectures?';
                const params = [];
                
                if (cohortId) params.push(`cohort_id=${cohortId}`);
                if (dateFrom) params.push(`date_from=${dateFrom}`);
                if (dateTo) params.push(`date_to=${dateTo}`);
                
                url += params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    renderRecordings(data.recordings);
                } else {
                    showToast('Failed to filter recordings', 'error');
                }
            } catch (error) {
                console.error('Error filtering recordings:', error);
                showToast('Error filtering recordings', 'error');
            }
        }

        function clearRecordingFilters() {
            document.getElementById('recordingCohortFilter').value = '';
            document.getElementById('recordingDateFrom').value = '';
            document.getElementById('recordingDateTo').value = '';
            loadRecordings();
        }

        async function downloadRecording(recordingId) {
            try {
                showToast('Downloading recording...', 'info');
                
                const response = await fetch(`/api/teacher/recordings/${recordingId}/download`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recording_${recordingId}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showToast('Recording download started!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to download recording', 'error');
                }
            } catch (error) {
                console.error('Error downloading recording:', error);
                showToast('Error downloading recording', 'error');
            }
        }

        function viewRecordingDetails(recordingId) {
            showToast('Recording details feature coming soon!', 'info');
        }

        function showUploadRecordingModal() {
            const modal = `
                <div class="modal fade" id="uploadRecordingModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Upload Recording</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="uploadRecordingForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="recordingTitle" class="form-label">Recording Title</label>
                                        <input type="text" class="form-control" id="recordingTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="recordingCohort" class="form-label">Cohort</label>
                                        <select class="form-control" id="recordingCohort" required>
                                            <option value="">Select a cohort</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="recordingLecture" class="form-label">Lecture</label>
                                        <select class="form-control" id="recordingLecture" required>
                                            <option value="">Select a lecture</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="recordingDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="recordingDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="recordingFile" class="form-label">Recording File</label>
                                        <input type="file" class="form-control" id="recordingFile" accept="video/*" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="uploadRecording()">Upload</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('uploadRecordingModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Load cohorts and lectures
            loadCohortsForRecording();
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('uploadRecordingModal'));
            modalElement.show();
        }

        async function loadCohortsForRecording() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohortSelect = document.getElementById('recordingCohort');
                    cohortSelect.innerHTML = '<option value="">Select a cohort</option>';
                    
                    data.cohorts.forEach(cohort => {
                        const option = document.createElement('option');
                        option.value = cohort.id;
                        option.textContent = cohort.name;
                        cohortSelect.appendChild(option);
                    });
                    
                    // Add event listener to load lectures when cohort changes
                    cohortSelect.addEventListener('change', loadLecturesForRecording);
                }
            } catch (error) {
                console.error('Error loading cohorts for recording:', error);
            }
        }

        async function loadLecturesForRecording() {
            try {
                const cohortId = document.getElementById('recordingCohort').value;
                const lectureSelect = document.getElementById('recordingLecture');
                
                if (!cohortId) {
                    lectureSelect.innerHTML = '<option value="">Select a cohort first</option>';
                    return;
                }
                
                // Show loading state
                lectureSelect.innerHTML = '<option value="">Loading lectures...</option>';
                lectureSelect.disabled = true;
                
                const response = await fetch(`/api/teacher/cohorts/${cohortId}/lectures`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    lectureSelect.innerHTML = '<option value="">Select a lecture</option>';
                    
                    if (data.lectures && data.lectures.length > 0) {
                        data.lectures.forEach(lecture => {
                            const option = document.createElement('option');
                            option.value = lecture.id;
                            option.textContent = `${lecture.title} - ${new Date(lecture.scheduled_time).toLocaleDateString()}`;
                            lectureSelect.appendChild(option);
                        });
                        showToast(`Loaded ${data.lectures.length} lectures`, 'success');
                    } else {
                        lectureSelect.innerHTML = '<option value="">No lectures found for this cohort</option>';
                        showToast('No lectures found for this cohort', 'info');
                    }
                } else {
                    lectureSelect.innerHTML = '<option value="">Error loading lectures</option>';
                    showToast('Error loading lectures: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading lectures for recording:', error);
                const lectureSelect = document.getElementById('recordingLecture');
                lectureSelect.innerHTML = '<option value="">Error loading lectures</option>';
                showToast('Error loading lectures. Please try again.', 'error');
            } finally {
                const lectureSelect = document.getElementById('recordingLecture');
                lectureSelect.disabled = false;
            }
        }

        async function uploadRecording() {
            try {
                const title = document.getElementById('recordingTitle').value;
                const cohortId = document.getElementById('recordingCohort').value;
                const lectureId = document.getElementById('recordingLecture').value;
                const description = document.getElementById('recordingDescription').value;
                const file = document.getElementById('recordingFile').files[0];
                
                if (!title || !cohortId || !lectureId || !file) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('recording', file);
                formData.append('lecture_id', lectureId);
                formData.append('cohort_id', cohortId);
                formData.append('title', title);
                formData.append('description', description);
                
                showToast('Uploading recording...', 'info');
                
                const response = await fetch('/api/teacher/recordings/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Recording uploaded successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('uploadRecordingModal')).hide();
                    loadRecordings(); // Refresh recordings list
                } else {
                    showToast(data.error || 'Failed to upload recording', 'error');
                }
            } catch (error) {
                console.error('Error uploading recording:', error);
                showToast('Error uploading recording', 'error');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadTeacherData();
            loadDashboardData();
        });

        async function loadTeacherData() {
            try {
                const response = await fetch('/api/teacher/profile');
                const data = await response.json();
                
                if (data.success) {
                    teacherData = data.teacher;
                    document.getElementById('teacherName').textContent = teacherData.name;
                }
            } catch (error) {
                console.error('Error loading teacher data:', error);
            }
        }

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadLectures(),
                    loadCohorts(),
                    loadMaterials(),
                    loadDiscussions(),
                    loadPolls(),
                    loadQuizzes(),
                    loadRecordings(),
                    loadProfile(),
                    loadRealTimeStats(),
                    loadTeacherStats()
                ]);
                
                // Set up real-time updates
                setInterval(loadRealTimeStats, 30000); // Update every 30 seconds
                setInterval(loadTeacherStats, 60000); // Update stats every minute
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadTeacherStats() {
            try {
                const response = await fetch('/api/teacher/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('myLectures').textContent = stats.lectures || 0;
                    document.getElementById('myCohorts').textContent = stats.cohorts || 0;
                    document.getElementById('myMaterials').textContent = stats.materials || 0;
                    document.getElementById('totalStudents').textContent = stats.students || 0;
                }
            } catch (error) {
                console.error('Error loading teacher stats:', error);
            }
        }

        async function loadLectures() {
            try {
                const response = await fetch('/api/teacher/lectures');
                const data = await response.json();
                
                if (data.success) {
                    const lectures = data.lectures;
                    document.getElementById('myLectures').textContent = lectures.length;
                    renderLectures(lectures);
                }
            } catch (error) {
                console.error('Error loading lectures:', error);
            }
        }

        async function loadCohorts() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohorts = data.cohorts;
                    document.getElementById('myCohorts').textContent = cohorts.length;
                    renderCohorts(cohorts);
                }
            } catch (error) {
                console.error('Error loading cohorts:', error);
            }
        }

        async function loadMaterials() {
            try {
                const response = await fetch('/api/teacher/materials');
                const data = await response.json();
                
                if (data.success) {
                    const materials = data.materials;
                    document.getElementById('myMaterials').textContent = materials.length;
                    renderMaterials(materials);
                }
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        async function loadProfile() {
            try {
                const response = await fetch('/api/teacher/profile');
                const data = await response.json();
                
                if (data.success) {
                    const teacher = data.teacher;
                    document.getElementById('teacherName').textContent = teacher.name;
                    renderProfile(teacher);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadRealTimeStats() {
            try {
                const response = await fetch('/api/teacher/analytics');
                const data = await response.json();
                
                if (data.success) {
                    const analytics = data.analytics;
                    updateStatsDisplay(analytics);
                }
            } catch (error) {
                console.error('Error loading real-time stats:', error);
            }
        }

        async function loadDiscussions() {
            try {
                console.log('Loading discussions...');
                const response = await fetch('/api/teacher/discussions');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Discussions response:', data);
                
                if (data.success) {
                    const discussions = data.discussions || [];
                    console.log('Discussions loaded:', discussions.length);
                    renderDiscussions(discussions);
                    
                    if (discussions.length === 0) {
                        showToast('No discussions found. Create one to start!', 'info');
                    }
                } else {
                    console.error('Failed to load discussions:', data.error);
                    showToast('Failed to load discussions: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading discussions:', error);
                showToast('Error loading discussions. Please refresh the page.', 'error');
            }
        }


        function renderLectures(lectures) {
            const container = document.getElementById('lecturesList');
            
            if (lectures.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-event fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No lectures created yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = lectures.map(lecture => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${lecture.title}</h6>
                        <p class="card-text text-primary fw-medium">${lecture.description || 'No description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${new Date(lecture.scheduled_time).toLocaleString()}
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" onclick="joinLecture('${lecture.id}')" title="Join Live Session">
                                    <i class="bi bi-camera-video"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editLecture('${lecture.id}')" title="Edit Lecture">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteLecture('${lecture.id}')" title="Delete Lecture">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderCohorts(cohorts) {
            const container = document.getElementById('cohortsList');
            
            if (cohorts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-people fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No cohorts assigned</p>
                        <button class="btn btn-primary" onclick="showAssignCohortModal()">
                            <i class="bi bi-plus-circle me-1"></i>Assign to Cohort
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cohorts.map(cohort => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${cohort.name}</h6>
                            <div class="d-flex gap-2">
                                <span class="badge bg-primary">Assigned</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewCohortDetails('${cohort.id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        <p class="card-text text-info fw-medium">${cohort.description || 'No description'}</p>
                        
                        <!-- Join Code Section -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-key"></i> Join Code
                                    </span>
                                    <input type="text" class="form-control" value="${cohort.join_code || 'N/A'}" readonly id="joinCode-${cohort.id}">
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyJoinCode('${cohort.id}')" title="Copy Join Code">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-outline-info" type="button" onclick="showQRCode('${cohort.id}', '${cohort.join_code || ''}')" title="Show QR Code">
                                        <i class="bi bi-qr-code"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Share this code with students to join the cohort</small>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-calendar me-2"></i>
                                    <small class="text-muted">Academic Year: ${cohort.academic_year || 'N/A'}</small>
                                </div>
                                <div class="d-flex align-items-center mt-1">
                                    <i class="bi bi-people me-2"></i>
                                    <small class="text-muted">Students: ${cohort.student_count || 0}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materialsList');
            
            if (materials.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No materials uploaded yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = materials.map(material => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">${material.title}</h6>
                        <p class="card-text text-success fw-medium">${material.description || 'No description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-file-earmark me-1"></i>
                                ${material.file_name}
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" onclick="downloadMaterial('${material.id}')" title="Download Material">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editMaterial('${material.id}')" title="Edit Material">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteMaterial('${material.id}')" title="Delete Material">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCreateLectureModal() {
            showToast('Create lecture feature coming soon!', 'info');
        }

        function showUploadMaterialModal() {
            showToast('Upload material feature coming soon!', 'info');
        }

        function showCreateQuizModal() {
            showToast('Create quiz feature coming soon!', 'info');
        }

        function viewAnalytics() {
            showToast('Analytics feature coming soon!', 'info');
        }

        function renderProfile(teacher) {
            const container = document.getElementById('profileContent');
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Personal Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>${teacher.name}</td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>${teacher.email}</td>
                            </tr>
                            <tr>
                                <td><strong>Member Since:</strong></td>
                                <td>${new Date(teacher.created_at).toLocaleDateString()}</td>
                            </tr>
                            <tr>
                                <td><strong>Last Login:</strong></td>
                                <td>${teacher.last_login ? new Date(teacher.last_login).toLocaleString() : 'Never'}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td><span class="badge bg-${teacher.is_active ? 'success' : 'danger'}">${teacher.is_active ? 'Active' : 'Inactive'}</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Statistics</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="card bg-primary text-white text-center mb-2">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">${teacher.stats.total_cohorts}</h5>
                                        <small>Cohorts</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-success text-white text-center mb-2">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">${teacher.stats.total_lectures}</h5>
                                        <small>Lectures</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-warning text-white text-center mb-2">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">${teacher.stats.total_materials}</h5>
                                        <small>Materials</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-info text-white text-center mb-2">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">${teacher.stats.total_polls}</h5>
                                        <small>Polls</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Recent Activity</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-primary">Recent Cohorts</h6>
                                ${teacher.recent_activity.cohorts.map(cohort => `
                                    <div class="card mb-2">
                                        <div class="card-body p-2">
                                            <h6 class="card-title mb-1">${cohort.name}</h6>
                                            <small class="text-muted">${cohort.description || 'No description'}</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-success">Recent Lectures</h6>
                                ${teacher.recent_activity.lectures.map(lecture => `
                                    <div class="card mb-2">
                                        <div class="card-body p-2">
                                            <h6 class="card-title mb-1">${lecture.title}</h6>
                                            <small class="text-muted">${new Date(lecture.scheduled_time).toLocaleString()}</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-warning">Recent Materials</h6>
                                ${teacher.recent_activity.materials.map(material => `
                                    <div class="card mb-2">
                                        <div class="card-body p-2">
                                            <h6 class="card-title mb-1">${material.title}</h6>
                                            <small class="text-muted">${new Date(material.uploaded_at).toLocaleDateString()}</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStatsDisplay(analytics) {
            // Update the stats cards with real-time data
            if (analytics.total_lectures !== undefined) {
                document.getElementById('myLectures').textContent = analytics.total_lectures;
            }
            if (analytics.total_cohorts !== undefined) {
                document.getElementById('myCohorts').textContent = analytics.total_cohorts;
            }
            if (analytics.total_materials !== undefined) {
                document.getElementById('myMaterials').textContent = analytics.total_materials;
            }
            if (analytics.total_students !== undefined) {
                document.getElementById('myStudents').textContent = analytics.total_students;
            }
            
            // Add a small indicator that stats are live
            const statsCards = document.querySelectorAll('.card.bg-primary, .card.bg-success, .card.bg-warning, .card.bg-info');
            statsCards.forEach(card => {
                if (!card.querySelector('.live-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'live-indicator';
                    indicator.innerHTML = '<i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i>';
                    indicator.style.position = 'absolute';
                    indicator.style.top = '10px';
                    indicator.style.right = '10px';
                    card.style.position = 'relative';
                    card.appendChild(indicator);
                }
            });
        }

        function renderDiscussions(discussions) {
            const container = document.getElementById('discussionsList');
            
            if (discussions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-chat-dots fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No discussions yet</p>
                        <button class="btn btn-primary" onclick="showCreateDiscussionModal()">
                            <i class="bi bi-plus-circle me-1"></i>Start First Discussion
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = discussions.map(discussion => `
                <div class="card mb-3 discussion-item" data-discussion-id="${discussion.id}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-chat-dots me-2"></i>
                            <h6 class="mb-0">${discussion.title}</h6>
                            ${discussion.is_pinned ? '<span class="badge bg-warning ms-2"> Pinned</span>' : ''}
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" onclick="viewDiscussion('${discussion.id}')">
                                <i class="bi bi-chat-dots me-1"></i>Open Chat
                            </button>
                            <button class="btn btn-outline-light btn-sm" onclick="toggleDiscussionChat('${discussion.id}')">
                                <i class="bi bi-chat me-1"></i>Quick Chat
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${discussion.description || discussion.content}</p>
                        <small class="text-white-50">
                            <i class="bi bi-calendar me-1"></i>
                            ${new Date(discussion.created_at).toLocaleString()}
                        </small>
                        
                        <!-- Chat Interface (Initially Hidden) -->
                        <div id="chat-${discussion.id}" class="mt-3" style="display: none;">
                            <div class="chat-container" style="height: 300px; border: 1px solid #dee2e6; border-radius: 0.375rem; overflow-y: auto; padding: 1rem; background-color: #f8f9fa;">
                                <div id="chatMessages-${discussion.id}" class="chat-messages">
                                    <div class="text-center text-white-50">
                                        <i class="bi bi-chat-dots fs-1"></i>
                                        <p class="text-white-50">Loading messages...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input mt-3">
                                <div class="input-group">
                                    <input type="text" id="chatMessageInput-${discussion.id}" class="form-control bg-light border-primary" placeholder="Type your message..." onkeypress="handleChatKeyPress(event, '${discussion.id}')" style="color: #000; font-weight: 500; border-radius: 25px 0 0 25px;" maxlength="500">
                                    <button class="btn btn-primary" type="button" onclick="sendChatMessage('${discussion.id}')" style="border-radius: 0 25px 25px 0;" title="Send message">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                                <small class="text-white-50 mt-1 d-block">Press Enter to send or click the send button</small>
                            </div>
                        </div>
                        
                        <style>
                        .teacher-message .message-content {
                            background-color: #e3f2fd;
                            border-radius: 1rem 1rem 0.25rem 1rem;
                            padding: 0.75rem;
                            margin-left: 2rem;
                        }
                        .student-message .message-content {
                            background-color: #f1f8e9;
                            border-radius: 1rem 1rem 1rem 0.25rem;
                            padding: 0.75rem;
                            margin-right: 2rem;
                        }
                        .message-text {
                            margin-top: 0.5rem;
                            line-height: 1.4;
                        }
                        .message-header {
                            font-size: 0.875rem;
                        }
                        .chat-container::-webkit-scrollbar {
                            width: 6px;
                        }
                        .chat-container::-webkit-scrollbar-track {
                            background: #f1f1f1;
                            border-radius: 3px;
                        }
                        .chat-container::-webkit-scrollbar-thumb {
                            background: #c1c1c1;
                            border-radius: 3px;
                        }
                        .chat-container::-webkit-scrollbar-thumb:hover {
                            background: #a8a8a8;
                        }
                        </style>
                    </div>
                </div>
            `).join('');
        }

        function showCreateDiscussionModal() {
            const modal = `
                <div class="modal fade" id="createDiscussionModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Start New Discussion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createDiscussionForm">
                                    <div class="mb-3">
                                        <label for="discussionTitle" class="form-label">Discussion Title</label>
                                        <input type="text" class="form-control" id="discussionTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="discussionCohort" class="form-label">Cohort</label>
                                        <select class="form-control" id="discussionCohort" required>
                                            <option value="">Select a cohort</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="discussionContent" class="form-label">Content</label>
                                        <textarea class="form-control" id="discussionContent" rows="4" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="discussionPinned">
                                            <label class="form-check-label" for="discussionPinned">
                                                Pin this discussion
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createDiscussion()">Start Discussion</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('createDiscussionModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Load cohorts for dropdown
            loadCohortsForDiscussion();
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('createDiscussionModal'));
            modalElement.show();
        }

        async function loadCohortsForDiscussion() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohortSelect = document.getElementById('discussionCohort');
                    cohortSelect.innerHTML = '<option value="">Select a cohort</option>';
                    
                    data.cohorts.forEach(cohort => {
                        const option = document.createElement('option');
                        option.value = cohort.id;
                        option.textContent = cohort.name;
                        cohortSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading cohorts:', error);
            }
        }

        async function createDiscussion() {
            try {
                const title = document.getElementById('discussionTitle').value;
                const cohortId = document.getElementById('discussionCohort').value;
                const content = document.getElementById('discussionContent').value;
                const isPinned = document.getElementById('discussionPinned').checked;

                if (!title || !cohortId || !content) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }

                const response = await fetch('/api/teacher/discussions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        cohort_id: cohortId,
                        title: title,
                        content: content,
                        is_pinned: isPinned
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Discussion created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createDiscussionModal')).hide();
                    loadDiscussions(); // Refresh discussions list
                } else {
                    showToast(data.error || 'Failed to create discussion', 'error');
                }
            } catch (error) {
                console.error('Error creating discussion:', error);
                showToast('Error creating discussion', 'error');
            }
        }

        function viewDiscussion(discussionId) {
            // Redirect to the real-time chatroom
            window.location.href = `/api/teacher/discussion/${discussionId}`;
        }

        function toggleDiscussionChat(discussionId) {
            const chatDiv = document.getElementById(`chat-${discussionId}`);
            if (chatDiv) {
                if (chatDiv.style.display === 'none') {
                    chatDiv.style.display = 'block';
                    loadChatMessages(discussionId);
                } else {
                    chatDiv.style.display = 'none';
                }
            }
        }

        function loadChatMessages(discussionId) {
            // Load actual discussion posts
            const chatMessages = document.getElementById(`chatMessages-${discussionId}`);
            if (chatMessages) {
                // Show loading state
                chatMessages.innerHTML = `
                    <div class="text-center text-white-50">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <span class="text-white-50">Loading messages...</span>
                    </div>
                `;
                
                // Fetch discussion posts
                fetch(`/api/teacher/discussions/${discussionId}/posts`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.posts && data.posts.length > 0) {
                            renderChatMessages(chatMessages, data.posts);
                        } else {
                            chatMessages.innerHTML = `
                                <div class="text-center text-white-50">
                                    <i class="bi bi-chat-dots fs-1"></i>
                                    <p class="text-white-50">No messages yet</p>
                                    <small class="text-white-50">Start the conversation!</small>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading messages:', error);
                        chatMessages.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="bi bi-exclamation-triangle fs-1"></i>
                                <p>Error loading messages</p>
                                <small>Please try again later</small>
                            </div>
                        `;
                    });
            }
        }
        
        function renderChatMessages(container, posts) {
            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-white-50 py-4">
                        <i class="bi bi-chat-dots fs-1"></i>
                        <p class="text-white-50">No messages yet</p>
                        <small class="text-white-50">Start the conversation!</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posts.map(post => {
                const authorName = post.teachers?.name || post.students?.name || (post.author_type === 'teacher' ? 'Teacher' : 'Student');
                const isTeacher = post.author_type === 'teacher';
                const messageTime = new Date(post.created_at).toLocaleString();
                
                return `
                    <div class="message mb-3 ${isTeacher ? 'teacher-message' : 'student-message'}">
                    <div class="d-flex align-items-start">
                            <div class="avatar me-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center ${isTeacher ? 'bg-primary' : 'bg-success'}" style="width: 40px; height: 40px;">
                                    <i class="bi bi-person-fill text-white"></i>
                                </div>
                        </div>
                        <div class="message-content flex-grow-1">
                                <div class="message-header d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        <strong class="message-author text-white me-2">${authorName}</strong>
                                        ${isTeacher ? '<span class="badge bg-primary">Teacher</span>' : '<span class="badge bg-success">Student</span>'}
                            </div>
                                    <small class="text-white-50">${messageTime}</small>
                        </div>
                                <div class="message-text text-white bg-dark bg-opacity-50 p-3 rounded-3">
                                    ${post.content}
                    </div>
                </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeyPress(event, discussionId) {
            if (event.key === 'Enter') {
                sendChatMessage(discussionId);
            }
        }

        function sendChatMessage(discussionId) {
            const input = document.getElementById(`chatMessageInput-${discussionId}`);
            const message = input.value.trim();
            
            if (!message) {
                showToast('Please enter a message', 'warning');
                return;
            }
            
            // Disable input and show loading
            input.disabled = true;
            const sendButton = input.nextElementSibling;
            const originalButtonContent = sendButton.innerHTML;
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
                // Send message to server
            fetch(`/api/teacher/discussions/${discussionId}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: message,
                        author_type: 'teacher'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        input.value = '';
                        // Reload messages to show the new one
                        loadChatMessages(discussionId);
                    showToast('Message sent successfully!', 'success');
                    } else {
                    showToast('Failed to send message: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                showToast('Error sending message. Please try again.', 'error');
            })
            .finally(() => {
                // Re-enable input and button
                input.disabled = false;
                sendButton.disabled = false;
                sendButton.innerHTML = originalButtonContent;
                input.focus();
            });
        }

        function showAssignCohortModal() {
            const modal = `
                <div class="modal fade" id="assignCohortModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Assign to Cohort</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="assignCohortForm">
                                    <div class="mb-3">
                                        <label for="cohortSelect" class="form-label">Select Cohort</label>
                                        <select class="form-control" id="cohortSelect" required>
                                            <option value="">Loading cohorts...</option>
                                        </select>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Select a cohort to get access to its students and create lectures for them.
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="assignToCohort()">Assign to Cohort</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('assignCohortModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Load cohorts for dropdown
            loadCohortsForAssignment();
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('assignCohortModal'));
            modalElement.show();
        }

        async function loadCohortsForAssignment() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohortSelect = document.getElementById('cohortSelect');
                    cohortSelect.innerHTML = '<option value="">Select a cohort</option>';
                    
                    if (data.cohorts && data.cohorts.length > 0) {
                        data.cohorts.forEach(cohort => {
                            const option = document.createElement('option');
                            option.value = cohort.id;
                            option.textContent = cohort.name;
                            cohortSelect.appendChild(option);
                        });
                    } else {
                        cohortSelect.innerHTML = '<option value="">No cohorts available</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading cohorts:', error);
                const cohortSelect = document.getElementById('cohortSelect');
                cohortSelect.innerHTML = '<option value="">Error loading cohorts</option>';
            }
        }

        async function assignToCohort() {
            try {
                const cohortId = document.getElementById('cohortSelect').value;

                if (!cohortId) {
                    showToast('Please select a cohort', 'error');
                    return;
                }

                const response = await fetch('/api/teacher/cohorts/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        cohort_id: cohortId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Successfully assigned to cohort!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('assignCohortModal')).hide();
                    loadCohorts(); // Refresh cohorts list
                } else {
                    showToast(data.error || 'Failed to assign to cohort', 'error');
                }
            } catch (error) {
                console.error('Error assigning to cohort:', error);
                showToast('Error assigning to cohort', 'error');
            }
        }

        function viewCohortDetails(cohortId) {
            showCohortDetailsModal(cohortId);
        }

        function copyJoinCode(cohortId, type = 'main') {
            const inputId = type === 'detail' ? `detailJoinCode-${cohortId}` : `joinCode-${cohortId}`;
            const joinCodeInput = document.getElementById(inputId);
            
            if (joinCodeInput && joinCodeInput.value !== 'N/A') {
                joinCodeInput.select();
                joinCodeInput.setSelectionRange(0, 99999); // For mobile devices
                
                try {
                    document.execCommand('copy');
                    showToast('Join code copied to clipboard!', 'success');
                    
                    // Visual feedback
                    const copyButton = joinCodeInput.nextElementSibling;
                    const originalIcon = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="bi bi-check"></i>';
                    copyButton.classList.remove('btn-outline-secondary');
                    copyButton.classList.add('btn-success');
                    
                    setTimeout(() => {
                        copyButton.innerHTML = originalIcon;
                        copyButton.classList.remove('btn-success');
                        copyButton.classList.add('btn-outline-secondary');
                    }, 2000);
                } catch (err) {
                    // Fallback for modern browsers
                    navigator.clipboard.writeText(joinCodeInput.value).then(() => {
                        showToast('Join code copied to clipboard!', 'success');
                    }).catch(() => {
                        showToast('Failed to copy join code', 'error');
                    });
                }
            } else {
                showToast('No join code available for this cohort', 'warning');
            }
        }

        function showQRCode(cohortId, joinCode, type = 'main') {
            if (!joinCode || joinCode === 'N/A') {
                showToast('No join code available for this cohort', 'warning');
                return;
            }

            // Create QR code modal
            const modal = `
                <div class="modal fade" id="qrCodeModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-qr-code me-2"></i>Join Code QR Code
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="mb-3">
                                    <div id="qrcode" class="d-flex justify-content-center"></div>
                                </div>
                                <div class="mb-3">
                                    <h6>Join Code: <code>${joinCode}</code></h6>
                                    <p class="text-muted">Students can scan this QR code or use the join code to join the cohort</p>
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                    <button class="btn btn-primary" onclick="copyJoinCode('${cohortId}', '${type}')">
                                        <i class="bi bi-clipboard me-1"></i>Copy Join Code
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="downloadQRCode()">
                                        <i class="bi bi-download me-1"></i>Download QR Code
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('qrCodeModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Generate QR code using a simple text-based approach
            generateQRCode(joinCode);
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('qrCodeModal'));
            modalElement.show();
        }

        function generateQRCode(text) {
            // Simple QR code generation using a library or API
            // For now, we'll create a simple text-based representation
            const qrContainer = document.getElementById('qrcode');
            
            // Create a simple QR code representation
            const qrDiv = document.createElement('div');
            qrDiv.className = 'border p-3 bg-white';
            qrDiv.style.fontFamily = 'monospace';
            qrDiv.style.fontSize = '12px';
            qrDiv.style.lineHeight = '1';
            qrDiv.style.letterSpacing = '2px';
            
            // Create a simple pattern based on the text
            let qrPattern = '';
            for (let i = 0; i < 10; i++) {
                let line = '';
                for (let j = 0; j < 10; j++) {
                    const charCode = text.charCodeAt((i * 10 + j) % text.length);
                    line += (charCode % 2 === 0) ? '' : '';
                }
                qrPattern += line + '\n';
            }
            
            qrDiv.textContent = qrPattern;
            qrContainer.appendChild(qrDiv);
            
            // Add a note about using a real QR code library
            const note = document.createElement('div');
            note.className = 'mt-2 text-muted small';
            note.innerHTML = '<em>Note: This is a simplified representation. For production, use a proper QR code library like qrcode.js</em>';
            qrContainer.appendChild(note);
        }

        function downloadQRCode() {
            showToast('QR code download feature coming soon!', 'info');
        }

        async function downloadMaterial(materialId) {
            try {
                showToast('Downloading material...', 'info');
                
                // Create a temporary link to download the file
                const downloadUrl = `/api/teacher/materials/${materialId}/download`;
                
                // Create a temporary anchor element and trigger download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = ''; // Let the server determine the filename
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Material download started!', 'success');
            } catch (error) {
                console.error('Error downloading material:', error);
                showToast('Error downloading material', 'error');
            }
        }


        async function loadCohortsForMaterial() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohortSelect = document.getElementById('materialCohort');
                    cohortSelect.innerHTML = '<option value="">Select a cohort</option>';
                    
                    if (data.cohorts && data.cohorts.length > 0) {
                        data.cohorts.forEach(cohort => {
                            const option = document.createElement('option');
                            option.value = cohort.id;
                            option.textContent = cohort.name;
                            cohortSelect.appendChild(option);
                        });
                    } else {
                        cohortSelect.innerHTML = '<option value="">No cohorts available</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading cohorts:', error);
                const cohortSelect = document.getElementById('materialCohort');
                cohortSelect.innerHTML = '<option value="">Error loading cohorts</option>';
            }
        }

        function showCohortDetailsModal(cohortId) {
            const modal = `
                <div class="modal fade" id="cohortDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Cohort Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="cohortDetailsContent">
                                    <div class="text-center py-4">
                                        <i class="bi bi-hourglass-split fs-1 text-muted"></i>
                                        <p class="text-muted mt-2">Loading cohort details...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('cohortDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Load cohort details
            loadCohortDetails(cohortId);
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('cohortDetailsModal'));
            modalElement.show();
        }

        async function loadCohortDetails(cohortId) {
            try {
                const response = await fetch(`/api/teacher/cohorts/${cohortId}/details`);
                const data = await response.json();
                
                if (data.success) {
                    renderCohortDetails(data.cohort, data.students, data.discussions, data.lectures);
                } else {
                    document.getElementById('cohortDetailsContent').innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
                            <p class="text-muted mt-2">Failed to load cohort details</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading cohort details:', error);
                document.getElementById('cohortDetailsContent').innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                        <p class="text-muted mt-2">Error loading cohort details</p>
                    </div>
                `;
            }
        }

        function renderCohortDetails(cohort, students, discussions, lectures) {
            const container = document.getElementById('cohortDetailsContent');
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Cohort Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>${cohort.name}</td>
                            </tr>
                            <tr>
                                <td><strong>Description:</strong></td>
                                <td>${cohort.description || 'No description'}</td>
                            </tr>
                            <tr>
                                <td><strong>Academic Year:</strong></td>
                                <td>${cohort.academic_year || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>Join Code:</strong></td>
                                <td>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-sm" value="${cohort.join_code || 'N/A'}" readonly id="detailJoinCode-${cohort.id}">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyJoinCode('${cohort.id}', 'detail')" title="Copy Join Code">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" type="button" onclick="showQRCode('${cohort.id}', '${cohort.join_code || ''}', 'detail')" title="Show QR Code">
                                            <i class="bi bi-qr-code"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Statistics</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="card bg-primary text-white text-center mb-2">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">${students.length}</h5>
                                        <small>Students</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-success text-white text-center mb-2">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">${discussions.length}</h5>
                                        <small>Discussions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-warning text-white text-center mb-2">
                                    <div class="card-body p-2">
                                        <h5 class="mb-0">${lectures.length}</h5>
                                        <small>Lectures</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-4">
                        <h6 class="text-primary">
                            <i class="bi bi-people me-2"></i>Students (${students.length})
                        </h6>
                        ${students.length > 0 ? students.slice(0, 5).map(student => `
                            <div class="card mb-2 border-start border-primary border-3">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 12px;">
                                            ${student.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <h6 class="card-title mb-0">${student.name}</h6>
                                            <small class="text-muted">${student.email}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-3">
                                <i class="bi bi-person-x fs-4 text-muted"></i>
                                <p class="text-muted mb-0">No students enrolled</p>
                            </div>
                        `}
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-success">
                            <i class="bi bi-chat-dots me-2"></i>Discussions (${discussions.length})
                        </h6>
                        ${discussions.length > 0 ? discussions.slice(0, 5).map(discussion => `
                            <div class="card mb-2 border-start border-success border-3">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 12px;">
                                            <i class="bi bi-chat"></i>
                                        </div>
                                        <div>
                                            <h6 class="card-title mb-0">${discussion.title}</h6>
                                            <small class="text-muted">${new Date(discussion.created_at).toLocaleDateString()}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-3">
                                <i class="bi bi-chat-x fs-4 text-muted"></i>
                                <p class="text-muted mb-0">No discussions yet</p>
                            </div>
                        `}
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-warning">
                            <i class="bi bi-calendar-event me-2"></i>Lectures (${lectures.length})
                        </h6>
                        ${lectures.length > 0 ? lectures.slice(0, 5).map(lecture => `
                            <div class="card mb-2 border-start border-warning border-3">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 12px;">
                                            <i class="bi bi-play-circle"></i>
                                        </div>
                                        <div>
                                            <h6 class="card-title mb-0">${lecture.title}</h6>
                                            <small class="text-muted">${new Date(lecture.scheduled_time).toLocaleDateString()}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-3">
                                <i class="bi bi-calendar-x fs-4 text-muted"></i>
                                <p class="text-muted mb-0">No lectures scheduled</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function editLecture(lectureId) {
            showToast('Edit lecture feature coming soon!', 'info');
        }

        function deleteLecture(lectureId) {
            if (confirm('Are you sure you want to delete this lecture?')) {
                showToast('Delete lecture feature coming soon!', 'info');
            }
        }

        function editMaterial(materialId) {
            showToast('Edit material feature coming soon!', 'info');
        }

        function deleteMaterial(materialId) {
            if (confirm('Are you sure you want to delete this material?')) {
                showToast('Delete material feature coming soon!', 'info');
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/teacher/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        // Create Lecture Modal
        function showCreateLectureModal() {
            const modal = `
                <div class="modal fade" id="createLectureModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create New Lecture</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createLectureForm">
                                    <div class="mb-3">
                                        <label for="lectureTitle" class="form-label">Lecture Title</label>
                                        <input type="text" class="form-control" id="lectureTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="lectureDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="lectureDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="lectureCohort" class="form-label">Cohort</label>
                                        <select class="form-control" id="lectureCohort" required>
                                            <option value="">Select a cohort</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="lectureDate" class="form-label">Scheduled Date & Time</label>
                                        <input type="datetime-local" class="form-control" id="lectureDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="lectureDuration" class="form-label">Duration (minutes)</label>
                                        <input type="number" class="form-control" id="lectureDuration" value="60" min="15" max="300">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createLecture()">Create Lecture</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('createLectureModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Load cohorts for dropdown
            loadCohortsForLecture();
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('createLectureModal'));
            modalElement.show();
        }

        async function loadCohortsForLecture() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohortSelect = document.getElementById('lectureCohort');
                    cohortSelect.innerHTML = '<option value="">Select a cohort</option>';
                    
                    data.cohorts.forEach(cohort => {
                        const option = document.createElement('option');
                        option.value = cohort.id;
                        option.textContent = cohort.name;
                        cohortSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading cohorts:', error);
            }
        }

        async function createLecture() {
            try {
                const title = document.getElementById('lectureTitle').value;
                const description = document.getElementById('lectureDescription').value;
                const cohortId = document.getElementById('lectureCohort').value;
                const scheduledTime = document.getElementById('lectureDate').value;
                const duration = document.getElementById('lectureDuration').value;

                if (!title || !cohortId || !scheduledTime) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }

                const response = await fetch('/api/teacher/lectures', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        title,
                        description,
                        cohort_id: cohortId,
                        scheduled_time: scheduledTime,
                        duration: parseInt(duration)
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Lecture created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createLectureModal')).hide();
                    loadLectures(); // Refresh lectures list
                } else {
                    showToast(data.error || 'Failed to create lecture', 'error');
                }
            } catch (error) {
                console.error('Error creating lecture:', error);
                showToast('Error creating lecture', 'error');
            }
        }

        // Upload Material Modal
        function showUploadMaterialModal() {
            const modal = `
                <div class="modal fade" id="uploadMaterialModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Upload Material</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="uploadMaterialForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="materialTitle" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="materialTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="materialCohort" class="form-label">Cohort</label>
                                        <select class="form-control" id="materialCohort" required>
                                            <option value="">Select a cohort</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="materialDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="materialDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="materialFile" class="form-label">File</label>
                                        <input type="file" class="form-control" id="materialFile">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="uploadMaterial()">Upload Material</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('uploadMaterialModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Load cohorts for dropdown
            loadCohortsForMaterial();
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('uploadMaterialModal'));
            modalElement.show();
        }

        async function uploadMaterial() {
            try {
                const title = document.getElementById('materialTitle').value;
                const description = document.getElementById('materialDescription').value;
                const cohortId = document.getElementById('materialCohort').value;
                const file = document.getElementById('materialFile').files[0];

                if (!title || !cohortId) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('title', title);
                formData.append('description', description);
                formData.append('cohort_id', cohortId);
                if (file) {
                    formData.append('file', file);
                    formData.append('file_name', file.name);
                    formData.append('file_type', file.type);
                }

                const response = await fetch('/api/teacher/materials', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Material uploaded successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('uploadMaterialModal')).hide();
                    loadMaterials(); // Refresh materials list
                } else {
                    showToast(data.error || 'Failed to upload material', 'error');
                }
            } catch (error) {
                console.error('Error uploading material:', error);
                showToast('Error uploading material', 'error');
            }
        }

        // Create Quiz Modal
        function showCreateQuizModal() {
            const modal = `
                <div class="modal fade" id="createQuizModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create Quiz</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createQuizForm">
                                    <div class="mb-3">
                                        <label for="quizTitle" class="form-label">Quiz Title</label>
                                        <input type="text" class="form-control" id="quizTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizCohort" class="form-label">Cohort</label>
                                        <select class="form-control" id="quizCohort" required>
                                            <option value="">Select a cohort</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="quizDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizDuration" class="form-label">Duration (minutes)</label>
                                        <input type="number" class="form-control" id="quizDuration" value="30" min="5" max="180">
                                    </div>
                                    <div class="mb-3">
                                        <label for="quizQuestions" class="form-label">Questions</label>
                                        <div id="quizQuestions">
                                            <div class="question-item mb-3 p-3 border rounded">
                                                <div class="mb-2">
                                                    <input type="text" class="form-control" placeholder="Question 1" required>
                                                </div>
                                                <div class="mb-2">
                                                    <input type="text" class="form-control" placeholder="Option A" required>
                                                </div>
                                                <div class="mb-2">
                                                    <input type="text" class="form-control" placeholder="Option B" required>
                                                </div>
                                                <div class="mb-2">
                                                    <input type="text" class="form-control" placeholder="Option C" required>
                                                </div>
                                                <div class="mb-2">
                                                    <input type="text" class="form-control" placeholder="Option D" required>
                                                </div>
                                                <div class="mb-2">
                                                    <select class="form-control">
                                                        <option value="A">Correct Answer: A</option>
                                                        <option value="B">Correct Answer: B</option>
                                                        <option value="C">Correct Answer: C</option>
                                                        <option value="D">Correct Answer: D</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuizQuestion()">Add Question</button>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createQuiz()">Create Quiz</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('createQuizModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Load cohorts for dropdown
            loadCohortsForQuiz();
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('createQuizModal'));
            modalElement.show();
        }

        async function loadCohortsForQuiz() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohortSelect = document.getElementById('quizCohort');
                    cohortSelect.innerHTML = '<option value="">Select a cohort</option>';
                    
                    data.cohorts.forEach(cohort => {
                        const option = document.createElement('option');
                        option.value = cohort.id;
                        option.textContent = cohort.name;
                        cohortSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading cohorts:', error);
            }
        }

        function addQuizQuestion() {
            const questionsContainer = document.getElementById('quizQuestions');
            const questionCount = questionsContainer.children.length + 1;
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item mb-3 p-3 border rounded';
            questionDiv.innerHTML = `
                <div class="mb-2">
                    <input type="text" class="form-control" placeholder="Question ${questionCount}" required>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" placeholder="Option A" required>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" placeholder="Option B" required>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" placeholder="Option C" required>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" placeholder="Option D" required>
                </div>
                <div class="mb-2">
                    <select class="form-control">
                        <option value="A">Correct Answer: A</option>
                        <option value="B">Correct Answer: B</option>
                        <option value="C">Correct Answer: C</option>
                        <option value="D">Correct Answer: D</option>
                    </select>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeQuizQuestion(this)">Remove Question</button>
            `;
            
            questionsContainer.appendChild(questionDiv);
        }

        function removeQuizQuestion(button) {
            const questionsContainer = document.getElementById('quizQuestions');
            if (questionsContainer.children.length > 1) {
                button.parentElement.remove();
            }
        }

        async function createQuiz() {
            try {
                const title = document.getElementById('quizTitle').value;
                const cohortId = document.getElementById('quizCohort').value;
                const description = document.getElementById('quizDescription').value;
                const duration = document.getElementById('quizDuration').value;

                if (!title || !cohortId) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }

                // Collect questions
                const questions = [];
                const questionItems = document.querySelectorAll('#quizQuestions .question-item');
                
                questionItems.forEach((item, index) => {
                    const inputs = item.querySelectorAll('input, select');
                    if (inputs.length >= 6) {
                        questions.push({
                            question: inputs[0].value,
                            question_text: inputs[0].value, // Add question_text for database compatibility
                            options: [inputs[1].value, inputs[2].value, inputs[3].value, inputs[4].value],
                            correct_answer: inputs[5].value
                        });
                    }
                });

                if (questions.length === 0) {
                    showToast('Please add at least one question', 'error');
                    return;
                }

                const response = await fetch('/api/teacher/quizzes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        title,
                        cohort_id: cohortId,
                        description,
                        duration: parseInt(duration),
                        questions
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Quiz created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createQuizModal')).hide();
                } else {
                    showToast(data.error || 'Failed to create quiz', 'error');
                }
            } catch (error) {
                console.error('Error creating quiz:', error);
                showToast('Error creating quiz', 'error');
            }
        }

        // View Analytics
        async function viewAnalytics() {
            try {
                const response = await fetch('/api/teacher/analytics');
                const data = await response.json();
                
                if (data.success) {
                    const analytics = data.analytics;
                    
                    // Create analytics modal
                    const modal = `
                        <div class="modal fade" id="analyticsModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Teacher Analytics</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row mb-4">
                                            <div class="col-md-3">
                                                <div class="card bg-primary text-white">
                                                    <div class="card-body text-center">
                                                        <h3>${analytics.total_lectures}</h3>
                                                        <p class="mb-0">Total Lectures</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-success text-white">
                                                    <div class="card-body text-center">
                                                        <h3>${analytics.total_polls}</h3>
                                                        <p class="mb-0">Total Polls</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-warning text-white">
                                                    <div class="card-body text-center">
                                                        <h3>${analytics.total_materials}</h3>
                                                        <p class="mb-0">Total Materials</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-info text-white">
                                                    <div class="card-body text-center">
                                                        <h3>${analytics.total_cohorts}</h3>
                                                        <p class="mb-0">Total Cohorts</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Recent Lectures</h6>
                                                <div class="list-group">
                                                    ${analytics.recent_lectures.map(lecture => `
                                                        <div class="list-group-item">
                                                            <h6 class="mb-1">${lecture.title}</h6>
                                                            <small class="text-muted">${new Date(lecture.scheduled_time).toLocaleString()}</small>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Recent Materials</h6>
                                                <div class="list-group">
                                                    ${analytics.recent_materials.map(material => `
                                                        <div class="list-group-item">
                                                            <h6 class="mb-1">${material.title}</h6>
                                                            <small class="text-muted">${new Date(material.uploaded_at).toLocaleString()}</small>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if any
                    const existingModal = document.getElementById('analyticsModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modal);
                    
                    // Show modal
                    const modalElement = new bootstrap.Modal(document.getElementById('analyticsModal'));
                    modalElement.show();
                } else {
                    showToast('Failed to load analytics', 'error');
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Error loading analytics', 'error');
            }
        }

        // Edit and Delete Lecture Functions
        async function editLecture(lectureId) {
            // Implementation for editing lecture
            showToast('Edit lecture functionality coming soon', 'info');
        }

        async function deleteLecture(lectureId) {
            if (!confirm('Are you sure you want to delete this lecture?')) {
                return;
            }

            try {
                const response = await fetch(`/api/teacher/lectures/${lectureId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Lecture deleted successfully!', 'success');
                    loadLectures(); // Refresh lectures list
                } else {
                    showToast(data.error || 'Failed to delete lecture', 'error');
                }
            } catch (error) {
                console.error('Error deleting lecture:', error);
                showToast('Error deleting lecture', 'error');
            }
        }

        // Start Live Session Function
        async function joinLecture(lectureId) {
            try {
                // Check if lecture is within the allowed time window
                const response = await fetch(`/api/teacher/live-session/${lectureId}`);
                
                if (response.ok) {
                    // Redirect to live session
                    window.location.href = `/api/teacher/live-session/${lectureId}`;
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Cannot start live session', 'error');
                }
            } catch (error) {
                console.error('Error starting live session:', error);
                showToast('Error starting live session', 'error');
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toast = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toast);
            
            const toastElement = new bootstrap.Toast(document.getElementById(toastId));
            toastElement.show();
        }

        // Poll Functions
        function showCreatePollModal() {
            const modalElement = new bootstrap.Modal(document.getElementById('createPollModal'));
            modalElement.show();
            // Load cohorts for poll creation
            loadCohortsForPoll();
        }

        async function loadCohortsForPoll() {
            try {
                const response = await fetch('/api/teacher/cohorts');
                const data = await response.json();
                
                if (data.success) {
                    const cohortSelect = document.getElementById('pollCohort');
                    cohortSelect.innerHTML = '<option value="">Select a cohort</option>';
                    
                    if (data.cohorts && data.cohorts.length > 0) {
                        data.cohorts.forEach(cohort => {
                            const option = document.createElement('option');
                            option.value = cohort.id;
                            option.textContent = cohort.name;
                            cohortSelect.appendChild(option);
                        });
                    } else {
                        cohortSelect.innerHTML = '<option value="">No cohorts available</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading cohorts for poll:', error);
                const cohortSelect = document.getElementById('pollCohort');
                cohortSelect.innerHTML = '<option value="">Error loading cohorts</option>';
            }
        }

        async function createPoll() {
            try {
                const question = document.getElementById('pollQuestion').value;
                const cohortId = document.getElementById('pollCohort').value;
                const options = Array.from(document.querySelectorAll('.poll-option')).map(opt => opt.value).filter(opt => opt.trim());

                if (!question || !cohortId || options.length < 2) {
                    showToast('Please fill in all required fields and add at least 2 options', 'error');
                    return;
                }

                const response = await fetch('/api/teacher/polls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cohort_id: cohortId,
                        question: question,
                        options: options
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Poll created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createPollModal')).hide();
                    loadPolls();
                } else {
                    showToast(data.error || 'Failed to create poll', 'error');
                }
            } catch (error) {
                console.error('Error creating poll:', error);
                showToast('Error creating poll', 'error');
            }
        }

        async function loadPolls() {
            try {
                const response = await fetch('/api/teacher/polls');
                const polls = await response.json();
                
                const pollsList = document.getElementById('pollsList');
                if (polls.length === 0) {
                    pollsList.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-bar-chart fs-1 text-muted"></i>
                            <p class="text-muted mt-2">No polls created yet</p>
                        </div>
                    `;
                } else {
                    pollsList.innerHTML = polls.map(poll => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">${poll.question}</h6>
                                <p class="card-text text-muted">Cohort: ${poll.cohort_id}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Created: ${new Date(poll.created_at).toLocaleString()}</small>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewPollResults('${poll.id}')">
                                            <i class="bi bi-eye me-1"></i>View Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading polls:', error);
                showToast('Error loading polls', 'error');
            }
        }

        async function viewPollResults(pollId) {
            try {
                const response = await fetch(`/api/teacher/polls/${pollId}/results`);
                const data = await response.json();
                
                if (data.success) {
                    // Display results in a modal
                    showPollResultsModal(data);
                    showToast('Poll results loaded', 'success');
                } else {
                    showToast(data.error || 'Failed to load poll results', 'error');
                }
            } catch (error) {
                console.error('Error loading poll results:', error);
                showToast('Error loading poll results', 'error');
            }
        }

        function showPollResultsModal(data) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="pollResultsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Poll Results: ${data.question}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <h6>Question:</h6>
                                    <p>${data.question}</p>
                                </div>
                                <div class="mb-3">
                                    <h6>Results:</h6>
                                    ${data.results.map(result => `
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>${result.option}</span>
                                                <span class="badge bg-primary">${result.votes} votes</span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: ${result.percentage}%" 
                                                     aria-valuenow="${result.percentage}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    ${result.percentage}%
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="text-muted">
                                    <small>Total votes: ${data.total_votes}</small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('pollResultsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('pollResultsModal'));
            modal.show();
            
            // Remove modal when hidden
            document.getElementById('pollResultsModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Quiz Functions
        function showCreateQuizModal() {
            const modalElement = new bootstrap.Modal(document.getElementById('createQuizModal'));
            modalElement.show();
            // Load cohorts for quiz creation
            loadCohortsForQuiz();
        }

        async function viewQuizResults(quizSetId) {
            try {
                const response = await fetch(`/api/teacher/quiz-responses/${quizSetId}`);
                const data = await response.json();
                
                if (data.success) {
                    showQuizResultsModal(data);
                    showToast('Quiz results loaded', 'success');
                } else {
                    showToast(data.error || 'Failed to load quiz results', 'error');
                }
            } catch (error) {
                console.error('Error loading quiz results:', error);
                showToast('Error loading quiz results', 'error');
            }
        }

        function showQuizResultsModal(data) {
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="quizResultsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Quiz Results: ${data.quiz_set?.title || 'Quiz'}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Overall Statistics</h6>
                                        <div class="card">
                                            <div class="card-body">
                                                <p><strong>Total Attempts:</strong> ${data.attempts?.length || 0}</p>
                                                <p><strong>Average Score:</strong> ${data.average_score || 0}%</p>
                                                <p><strong>Completion Rate:</strong> ${data.completion_rate || 0}%</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Question Analysis</h6>
                                        <div class="card">
                                            <div class="card-body">
                                                <p><strong>Total Questions:</strong> ${data.questions?.length || 0}</p>
                                                <p><strong>Average Accuracy:</strong> ${data.average_accuracy || 0}%</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h6>Student Performance</h6>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Student</th>
                                                    <th>Score</th>
                                                    <th>Correct Answers</th>
                                                    <th>Total Questions</th>
                                                    <th>Percentage</th>
                                                    <th>Status</th>
                                                    <th>Attempted At</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.attempts?.map(attempt => `
                                                    <tr>
                                                        <td>${attempt.student_name || 'Unknown'}</td>
                                                        <td>${attempt.score || 0}</td>
                                                        <td>${attempt.correct_answers || 0}</td>
                                                        <td>${attempt.total_questions || 0}</td>
                                                        <td>${attempt.percentage?.toFixed(1) || 0}%</td>
                                                        <td>
                                                            <span class="badge ${attempt.completed ? 'bg-success' : 'bg-warning'}">
                                                                ${attempt.completed ? 'Completed' : 'Incomplete'}
                                                            </span>
                                                        </td>
                                                        <td>${new Date(attempt.started_at).toLocaleString()}</td>
                                                    </tr>
                                                `).join('') || '<tr><td colspan="7" class="text-center">No attempts found</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h6>Question Breakdown</h6>
                                    <div class="row">
                                        ${data.questions?.map(question => `
                                            <div class="col-md-6 mb-3">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Question ${question.order_index || ''}</h6>
                                                        <p class="card-text">${question.question_text}</p>
                                                        <p><strong>Correct Answer:</strong> ${question.correct_answer}</p>
                                                        <p><strong>Accuracy:</strong> ${question.accuracy?.toFixed(1) || 0}%</p>
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar" role="progressbar" 
                                                                 style="width: ${question.accuracy || 0}%" 
                                                                 aria-valuenow="${question.accuracy || 0}" 
                                                                 aria-valuemin="0" 
                                                                 aria-valuemax="100">
                                                                ${question.accuracy?.toFixed(1) || 0}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('') || '<div class="col-12 text-center">No questions found</div>'}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('quizResultsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('quizResultsModal'));
            modal.show();
            
            // Remove modal when hidden
            document.getElementById('quizResultsModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        async function createQuiz() {
            try {
                const title = document.getElementById('quizTitle').value;
                const description = document.getElementById('quizDescription').value;
                const cohortId = document.getElementById('quizCohort').value;
                const questions = getQuizQuestions();

                if (!title || !cohortId || questions.length === 0) {
                    showToast('Please fill in all required fields and add at least one question', 'error');
                    return;
                }

                const response = await fetch('/api/teacher/quizzes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cohort_id: cohortId,
                        title: title,
                        description: description,
                        questions: questions
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Quiz created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createQuizModal')).hide();
                    loadQuizzes();
                } else {
                    showToast(data.error || 'Failed to create quiz', 'error');
                }
            } catch (error) {
                console.error('Error creating quiz:', error);
                showToast('Error creating quiz', 'error');
            }
        }

        function getQuizQuestions() {
            const questions = [];
            const questionElements = document.querySelectorAll('.quiz-question');
            
            questionElements.forEach((element, index) => {
                const questionText = element.querySelector('.question-text').value;
                const options = Array.from(element.querySelectorAll('.question-option')).map(opt => opt.value).filter(opt => opt.trim());
                const correctAnswer = element.querySelector('.correct-answer').value;
                
                if (questionText && options.length >= 2 && correctAnswer) {
                    questions.push({
                        question: questionText,
                        type: 'multiple_choice',
                        options: options,
                        correct_answer: correctAnswer
                    });
                }
            });
            
            return questions;
        }

        async function loadQuizzes() {
            try {
                const response = await fetch('/api/teacher/quizzes');
                const data = await response.json();
                
                if (data.success) {
                    const quizzes = data.quizzes;
                const quizzesList = document.getElementById('quizzesList');
                if (quizzes.length === 0) {
                    quizzesList.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-question-circle fs-1 text-muted"></i>
                            <p class="text-muted mt-2">No quizzes created yet</p>
                        </div>
                    `;
                } else {
                    quizzesList.innerHTML = quizzes.map(quiz => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">${quiz.title}</h6>
                                <p class="card-text">${quiz.description || ''}</p>
                                    <p class="card-text text-muted">Cohort: ${quiz.cohort_name || quiz.cohort_id}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Created: ${new Date(quiz.created_at).toLocaleString()}</small>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewQuizResponses('${quiz.id}')">
                                            <i class="bi bi-eye me-1"></i>View Responses
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
                showToast('Error loading quizzes', 'error');
            }
        }

        async function viewQuizResponses(quizId) {
            try {
                const response = await fetch(`/api/teacher/quiz-responses/${quizId}`);
                const data = await response.json();
                
                // Show responses in a modal or new page
                showToast('Quiz responses loaded', 'success');
            } catch (error) {
                console.error('Error loading quiz responses:', error);
                showToast('Error loading quiz responses', 'error');
            }
        }

        // Poll helper functions
        function addPollOption() {
            const optionsContainer = document.getElementById('pollOptions');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'input-group mb-2';
            optionDiv.innerHTML = `
                <input type="text" class="form-control poll-option" placeholder="Option ${optionsContainer.children.length + 1}" required>
                <button class="btn btn-outline-danger" type="button" onclick="removePollOption(this)"></button>
            `;
            optionsContainer.appendChild(optionDiv);
        }

        function removePollOption(button) {
            const optionsContainer = document.getElementById('pollOptions');
            if (optionsContainer.children.length > 2) {
                button.parentElement.remove();
            } else {
                showToast('At least 2 options are required', 'error');
            }
        }

        // Quiz helper functions
        function addQuizQuestion() {
            const questionsContainer = document.getElementById('quizQuestions');
            const questionNumber = questionsContainer.children.length + 1;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'quiz-question border p-3 mb-3';
            questionDiv.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Question ${questionNumber}</label>
                    <input type="text" class="form-control question-text" placeholder="Enter question" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Options</label>
                    <div class="question-options">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control question-option" placeholder="Option A" required>
                            <button class="btn btn-outline-danger" type="button" onclick="removeQuestionOption(this)"></button>
                        </div>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control question-option" placeholder="Option B" required>
                            <button class="btn btn-outline-danger" type="button" onclick="removeQuestionOption(this)"></button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addQuestionOption(this)">+ Add Option</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Correct Answer</label>
                    <select class="form-select correct-answer" required>
                        <option value="">Select correct answer</option>
                        <option value="a">A</option>
                        <option value="b">B</option>
                    </select>
                </div>
            `;
            questionsContainer.appendChild(questionDiv);
        }

        function addQuestionOption(button) {
            const optionsContainer = button.previousElementSibling;
            const optionDiv = document.createElement('div');
            optionDiv.className = 'input-group mb-2';
            optionDiv.innerHTML = `
                <input type="text" class="form-control question-option" placeholder="Option ${String.fromCharCode(65 + optionsContainer.children.length)}" required>
                <button class="btn btn-outline-danger" type="button" onclick="removeQuestionOption(this)"></button>
            `;
            optionsContainer.appendChild(optionDiv);
            updateCorrectAnswerOptions(button);
        }

        function removeQuestionOption(button) {
            const optionsContainer = button.parentElement.parentElement;
            if (optionsContainer.children.length > 2) {
                button.parentElement.remove();
                updateCorrectAnswerOptions(button);
            } else {
                showToast('At least 2 options are required', 'error');
            }
        }

        function updateCorrectAnswerOptions(button) {
            const questionDiv = button.closest('.quiz-question');
            const correctAnswerSelect = questionDiv.querySelector('.correct-answer');
            const options = questionDiv.querySelectorAll('.question-option');
            
            // Clear existing options
            correctAnswerSelect.innerHTML = '<option value="">Select correct answer</option>';
            
            // Add new options
            options.forEach((option, index) => {
                const optionValue = String.fromCharCode(65 + index).toLowerCase();
                const optionText = String.fromCharCode(65 + index);
                const optionElement = document.createElement('option');
                optionElement.value = optionValue;
                optionElement.textContent = optionText;
                correctAnswerSelect.appendChild(optionElement);
            });
        }

        function renderQuizzes(quizzes) {
            const container = document.getElementById('quizzesList');
            
            if (quizzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-question-circle fs-1 text-muted"></i>
                        <p class="text-muted mt-2">No quizzes created yet</p>
                        <button class="btn btn-primary btn-sm" onclick="showCreateQuizModal()">
                            <i class="bi bi-plus-circle me-1"></i>Create Quiz
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = quizzes.map(quiz => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${quiz.title}</h6>
                            <p class="card-text">${quiz.description || ''}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Cohort: ${quiz.cohort_id}</small>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="viewQuizResponses('${quiz.id}')">
                                        <i class="bi bi-eye me-1"></i>View Responses
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="viewQuizResults('${quiz.id}')">
                                        <i class="bi bi-bar-chart me-1"></i>Results
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
    </script>

    <!-- Create Poll Modal -->
    <div class="modal fade" id="createPollModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Poll</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPollForm">
                        <div class="mb-3">
                            <label class="form-label">Question</label>
                            <input type="text" class="form-control" id="pollQuestion" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cohort</label>
                            <select class="form-select" id="pollCohort" required>
                                <option value="">Select a cohort</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Options</label>
                            <div id="pollOptions">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control poll-option" placeholder="Option 1" required>
                                    <button class="btn btn-outline-danger" type="button" onclick="removePollOption(this)"></button>
                                </div>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control poll-option" placeholder="Option 2" required>
                                    <button class="btn btn-outline-danger" type="button" onclick="removePollOption(this)"></button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPollOption()">+ Add Option</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createPoll()">Create Poll</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Quiz Modal -->
    <div class="modal fade" id="createQuizModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Quiz</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createQuizForm">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="quizTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="quizDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cohort</label>
                            <select class="form-select" id="quizCohort" required>
                                <option value="">Select a cohort</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Questions</label>
                            <div id="quizQuestions">
                                <div class="quiz-question border p-3 mb-3">
                                    <div class="mb-3">
                                        <label class="form-label">Question 1</label>
                                        <input type="text" class="form-control question-text" placeholder="Enter question" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Options</label>
                                        <div class="question-options">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control question-option" placeholder="Option A" required>
                                                <button class="btn btn-outline-danger" type="button" onclick="removeQuestionOption(this)"></button>
                                            </div>
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control question-option" placeholder="Option B" required>
                                                <button class="btn btn-outline-danger" type="button" onclick="removeQuestionOption(this)"></button>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addQuestionOption(this)">+ Add Option</button>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Correct Answer</label>
                                        <select class="form-select correct-answer" required>
                                            <option value="">Select correct answer</option>
                                            <option value="a">A</option>
                                            <option value="b">B</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addQuizQuestion()">+ Add Question</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createQuiz()">Create Quiz</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>